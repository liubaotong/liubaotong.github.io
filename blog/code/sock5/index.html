<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<link rel="icon" type="image/svg+xml" href="/favicon.svg">
		<meta name="generator" content="Astro v2.2.1">
		<title></title>
	<link rel="stylesheet" href="/_astro/001.c8750cb8.css" /></head>
	<body>
		<h1 id="gorm使用详解">gorm使用详解</h1>
<h2 id="user">user:</h2>
<p>gorm使用详解</p>
<h2 id="assistant">assistant:</h2>
<p>GORM是一种ORM（对象关系映射）框架，用于处理数据库操作，适用于Google Go语言。下面是GORM使用的详细解释：</p>
<ol>
<li>安装GORM</li>
</ol>
<p>使用GORM之前，你需要先安装它。你可以使用以下命令安装它：go get -u github.com/jinzhu/gorm</p>
<ol start="2">
<li>连接数据库</li>
</ol>
<p>在GORM中进行数据库操作之前，您需要设置连接到数据库的详细信息。这是一个连接MySQL数据库的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">db, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> gorm.</span><span style="color: #79C0FF">Open</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"mysql"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"user:password@tcp(host:port)/database"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">panic</span><span style="color: #C9D1D9">(err)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #FF7B72">defer</span><span style="color: #C9D1D9"> db.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span></code></pre>
<ol start="3">
<li>定义模型</li>
</ol>
<p>在GORM中，您需要定义模型，即用于操作数据库的实体类。以下是一个示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">User</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    gorm.Model</span></span>
<span class="line"><span style="color: #C9D1D9">    Name                </span><span style="color: #FF7B72">string</span></span>
<span class="line"><span style="color: #C9D1D9">    Email               </span><span style="color: #FF7B72">string</span><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">`gorm:"unique;not null"`</span></span>
<span class="line"><span style="color: #C9D1D9">    PasswordHash        </span><span style="color: #FF7B72">string</span></span>
<span class="line"><span style="color: #C9D1D9">    PasswordResetToken  </span><span style="color: #FF7B72">*</span><span style="color: #FF7B72">string</span></span>
<span class="line"><span style="color: #C9D1D9">    PasswordResetSentAt </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">time.Time</span></span>
<span class="line"><span style="color: #C9D1D9">    RememberToken       </span><span style="color: #FF7B72">string</span><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">`gorm:"unique"`</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<ol start="4">
<li>创建表</li>
</ol>
<p>在GORM中，您可以使用以下代码创建表：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">CreateTable</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">User{})</span></span></code></pre>
<ol start="5">
<li>插入数据</li>
</ol>
<p>在GORM中，您可以使用以下代码将数据插入数据库：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{Name: </span><span style="color: #A5D6FF">"John Doe"</span><span style="color: #C9D1D9">, Email: </span><span style="color: #A5D6FF">"johndoe@example.com"</span><span style="color: #C9D1D9">, PasswordHash: </span><span style="color: #A5D6FF">"mypassword"</span><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">Create</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user)</span></span></code></pre>
<ol start="6">
<li>查询数据</li>
</ol>
<p>在GORM中，您可以使用以下代码查询数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">First</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user, id)</span></span></code></pre>
<ol start="7">
<li>更新数据</li>
</ol>
<p>在GORM中，您可以使用以下代码更新数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">First</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user, id)</span></span>
<span class="line"><span style="color: #C9D1D9">user.Name </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"New Name"</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">Save</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user)</span></span></code></pre>
<ol start="8">
<li>删除数据</li>
</ol>
<p>在GORM中，您可以使用以下代码删除数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">First</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user, id)</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">Delete</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user)</span></span></code></pre>
<p>以上是关于GORM使用方面的详细解释，希望这可以帮助您更好地理解如何使用GORM进行数据库操作。</p>
<h2 id="user-1">user:</h2>
<p>操作sqlite</p>
<h2 id="assistant-1">assistant:</h2>
<p>GORM同样适用于SQLite数据库。下面是使用GORM操作SQLite数据库的详细说明：</p>
<ol>
<li>安装SQLite驱动程序</li>
</ol>
<p>您需要先安装SQLite驱动程序，并导入它。您可以使用以下命令安装它：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">go</span><span style="color: #C9D1D9"> get </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">u github.com</span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9">mattn</span><span style="color: #FF7B72">/go-</span><span style="color: #C9D1D9">sqlite3</span></span></code></pre>
<ol start="2">
<li>连接SQLite数据库</li>
</ol>
<p>使用SQLite时，在连接语句中您需要指定SQLite的URL：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">db, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> gorm.</span><span style="color: #79C0FF">Open</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"sqlite3"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"/path/to/your/database.db"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">panic</span><span style="color: #C9D1D9">(err)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #FF7B72">defer</span><span style="color: #C9D1D9"> db.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span></code></pre>
<ol start="3">
<li>定义模型</li>
</ol>
<p>在SQLite中定义模型的方式与其他数据库非常相似。以下是一个示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">User</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    gorm.Model</span></span>
<span class="line"><span style="color: #C9D1D9">    Name    </span><span style="color: #FF7B72">string</span></span>
<span class="line"><span style="color: #C9D1D9">    Age     </span><span style="color: #FF7B72">int</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>使用”Model”结构体是为了在模型中自动生成ID、CreateTime、UpdateTime等公共字段。</p>
<ol start="4">
<li>创建表</li>
</ol>
<p>在SQLite中，您可以使用以下代码创建表：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">CreateTable</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">User{})</span></span></code></pre>
<ol start="5">
<li>插入数据</li>
</ol>
<p>在SQLite中，您可以使用以下代码将数据插入数据库：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{Name: </span><span style="color: #A5D6FF">"John Doe"</span><span style="color: #C9D1D9">, Age: </span><span style="color: #79C0FF">30</span><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">Create</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user)</span></span></code></pre>
<ol start="6">
<li>查询数据</li>
</ol>
<p>在SQLite中，您可以使用以下代码查询数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">First</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user, id)</span></span></code></pre>
<ol start="7">
<li>更新数据</li>
</ol>
<p>在SQLite中，您可以使用以下代码更新数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">First</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user, id)</span></span>
<span class="line"><span style="color: #C9D1D9">user.Age </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">40</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">Save</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user)</span></span></code></pre>
<ol start="8">
<li>删除数据</li>
</ol>
<p>在SQLite中，您可以使用以下代码删除数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> User{}</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">First</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user, id)</span></span>
<span class="line"><span style="color: #C9D1D9">db.</span><span style="color: #79C0FF">Delete</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">user)</span></span></code></pre>
<p>希望这些介绍能够帮助您更好地了解如何使用GORM操作SQLite数据库。</p>
<h2 id="user-2">user:</h2>
<p>go语言实现一个sock5代理</p>
<h2 id="assistant-2">assistant:</h2>
<p>下面是一个使用Go语言实现Sock5代理的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">flag</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">io</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">log</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">net</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">os</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">handleConnection</span><span style="color: #C9D1D9">(conn net.Conn) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 读取客户端版本信息</span></span>
<span class="line"><span style="color: #C9D1D9">    buf </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">byte</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    n, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> conn.</span><span style="color: #79C0FF">Read</span><span style="color: #C9D1D9">(buf)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"read client version error: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 验证客户端版本协议，socks5版本号为05</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"client version protocol error"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 回应客户端，可以使用无验证方式</span></span>
<span class="line"><span style="color: #C9D1D9">    conn.</span><span style="color: #79C0FF">Write</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">byte</span><span style="color: #C9D1D9">{</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">})</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 接收客户端请求</span></span>
<span class="line"><span style="color: #C9D1D9">    n, err </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> conn.</span><span style="color: #79C0FF">Read</span><span style="color: #C9D1D9">(buf)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"read client request error: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 验证客户端请求协议，socks5协议规定连接方式为0x01，ofo在client request的8位位进制数中一定是0，目的地址和端口号各占2个字节</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"client request protoocl error"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">        addr </span><span style="color: #FF7B72">string</span></span>
<span class="line"><span style="color: #C9D1D9">        port </span><span style="color: #FF7B72">int</span></span>
<span class="line"><span style="color: #C9D1D9">    )</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 获取目标地址和端口号</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">switch</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">] {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">0x</span><span style="color: #79C0FF">01</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> net.</span><span style="color: #79C0FF">IPv4</span><span style="color: #C9D1D9">(buf[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">], buf[</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">], buf[</span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">], buf[</span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">]).</span><span style="color: #79C0FF">String</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        port </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9">(buf[</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">]) </span><span style="color: #FF7B72">&#x3C;&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9">(buf[</span><span style="color: #79C0FF">9</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">0x</span><span style="color: #79C0FF">03</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// 从缓冲区中读取域名</span></span>
<span class="line"><span style="color: #C9D1D9">        n, err </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> io.</span><span style="color: #79C0FF">ReadAtLeast</span><span style="color: #C9D1D9">(conn, buf, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"read domain length errpr: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">            conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        domainLength </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9">(buf[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">        n, err </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> io.</span><span style="color: #79C0FF">ReadAtLeast</span><span style="color: #C9D1D9">(conn, buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">:domainLength</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">], domainLength</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"read domain error: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">            conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        domain </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">(buf[</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> : domainLength</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">        addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> domain</span></span>
<span class="line"><span style="color: #C9D1D9">        port </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9">(buf[</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">domainLength]) </span><span style="color: #FF7B72">&#x3C;&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9">(buf[</span><span style="color: #79C0FF">6</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">domainLength])</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">0x</span><span style="color: #79C0FF">04</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"IPv6 address not supported"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">default</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"unkown address type"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 连接目标服务器</span></span>
<span class="line"><span style="color: #C9D1D9">    tcpAddr, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> net.</span><span style="color: #79C0FF">ResolveTCPAddr</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"tcp"</span><span style="color: #C9D1D9">, fmt.</span><span style="color: #79C0FF">Sprintf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">%s</span><span style="color: #A5D6FF">:</span><span style="color: #79C0FF">%d</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">, addr, port))</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"resolve tcp address error: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">        conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    server, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> net.</span><span style="color: #79C0FF">DialTCP</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"tcp"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9">, tcpAddr)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        log.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"dial tcp address error: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">        conn.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 告诉客户端连接已建立</span></span>
<span class="line"><span style="color: #C9D1D9">    conn.</span><span style="color: #79C0FF">Write</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">byte</span><span style="color: #C9D1D9">{</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">})</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 开始对拷数据</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">go</span><span style="color: #C9D1D9"> io.</span><span style="color: #79C0FF">Copy</span><span style="color: #C9D1D9">(server, conn)</span></span>
<span class="line"><span style="color: #C9D1D9">    io.</span><span style="color: #79C0FF">Copy</span><span style="color: #C9D1D9">(conn, server)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    lAddr </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> flag.</span><span style="color: #79C0FF">String</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"l"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"127.0.0.1:8000"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"local address"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    flag.</span><span style="color: #79C0FF">Parse</span><span style="color: #C9D1D9">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    listener, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> net.</span><span style="color: #79C0FF">Listen</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"tcp"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">lAddr)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        fmt.</span><span style="color: #79C0FF">Fprintln</span><span style="color: #C9D1D9">(os.Stderr, </span><span style="color: #A5D6FF">"Cannot listen: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">        os.</span><span style="color: #79C0FF">Exit</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"proxy: listening on "</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">lAddr)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        conn, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> listener.</span><span style="color: #79C0FF">Accept</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            fmt.</span><span style="color: #79C0FF">Fprintln</span><span style="color: #C9D1D9">(os.Stderr, </span><span style="color: #A5D6FF">"Accept error: "</span><span style="color: #C9D1D9">, err)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">continue</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">go</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">handleConnection</span><span style="color: #C9D1D9">(conn)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>该代理程序开启一个TCP连接监听，接受客户端的socks5请求，解析请求参数获取目标服务器地址，然后建立与目标服务器的连接，对拷数据完成数据传输。</p>
<h2 id="user-3">user:</h2>
<p>zig实现一个sock5代理</p>
<h2 id="assistant-3">assistant:</h2>
<p>以下是一个使用Zig语言实现Sock5代理的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">const std = @import("std");</span></span>
<span class="line"><span style="color: #c9d1d9">const mem = std.mem;</span></span>
<span class="line"><span style="color: #c9d1d9">const net = std.net;</span></span>
<span class="line"><span style="color: #c9d1d9">const io = std.io;</span></span>
<span class="line"><span style="color: #c9d1d9">const os = std.os;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">fn handleConnection(conn: net.Conn) !void {</span></span>
<span class="line"><span style="color: #c9d1d9">    var buf: [256]u8 = undefined;</span></span>
<span class="line"><span style="color: #c9d1d9">    var readResult = try conn.readAll(&#x26;buf);</span></span>
<span class="line"><span style="color: #c9d1d9">    if (readResult.isError()) return error.!?;</span></span>
<span class="line"><span style="color: #c9d1d9">    var bytesRead = readResult.unwrap();</span></span>
<span class="line"><span style="color: #c9d1d9">    if (buf[0] != 5) return error.!?;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    try conn.writeAll([]u8{5, 0});</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    readResult = try conn.readAll(&#x26;buf);</span></span>
<span class="line"><span style="color: #c9d1d9">    if (readResult.isError()) return error.!?;</span></span>
<span class="line"><span style="color: #c9d1d9">    bytesRead = readResult.unwrap();</span></span>
<span class="line"><span style="color: #c9d1d9">    if (buf[0] != 5 or buf[1] != 1 or buf[2] != 0) return error.!?;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var addr: ?[]u8 = undefined;</span></span>
<span class="line"><span style="color: #c9d1d9">    const MAX_ADDR_SIZE = 255;</span></span>
<span class="line"><span style="color: #c9d1d9">    switch (buf[3]) {</span></span>
<span class="line"><span style="color: #c9d1d9">        // IPv4</span></span>
<span class="line"><span style="color: #c9d1d9">        0x01: {</span></span>
<span class="line"><span style="color: #c9d1d9">            const SIZE = 6;</span></span>
<span class="line"><span style="color: #c9d1d9">            addr = try std.heap.alloc(u8, SIZE);</span></span>
<span class="line"><span style="color: #c9d1d9">            try mem.copy(addr.+[0], &#x26;buf[4], 4);</span></span>
<span class="line"><span style="color: #c9d1d9">            try mem.copy(addr.+[4], &#x26;buf[8], 2);</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">        // Domain name</span></span>
<span class="line"><span style="color: #c9d1d9">        0x03: {</span></span>
<span class="line"><span style="color: #c9d1d9">            var domainLen = u32.init(0);</span></span>
<span class="line"><span style="color: #c9d1d9">            try conn.readExact(&#x26;domainLen, 1);</span></span>
<span class="line"><span style="color: #c9d1d9">            if (domainLen > MAX_ADDR_SIZE) return error.!?;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">            addr = try std.heap.alloc(u8, domainLen + 2);</span></span>
<span class="line"><span style="color: #c9d1d9">            addr[0] = 0x00;</span></span>
<span class="line"><span style="color: #c9d1d9">            addr[1] = domainLen;</span></span>
<span class="line"><span style="color: #c9d1d9">            try conn.readExact(addr.+[2], domainLen);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">            var port: u16 = 0;</span></span>
<span class="line"><span style="color: #c9d1d9">            try conn.readExact(&#x26;port, 2);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">            try mem.copy(addr.+[domainLen + 2], &#x26;port, 2);</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">        // IPv6</span></span>
<span class="line"><span style="color: #c9d1d9">        0x04: {</span></span>
<span class="line"><span style="color: #c9d1d9">            // IPv6 address handling not implemented yet.</span></span>
<span class="line"><span style="color: #c9d1d9">            return error.!?;</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">        else: {</span></span>
<span class="line"><span style="color: #c9d1d9">            return error.!?;</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var server = try net.connectUdp(addr);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer server.close();</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var response: [10]u8 = undefined;</span></span>
<span class="line"><span style="color: #c9d1d9">    try mem.copy(response[0..2], &#x26;[5, 0]);</span></span>
<span class="line"><span style="color: #c9d1d9">    try conn.writeAll(response);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    try mem.copy(response[0..10], &#x26;[5, 0, 0, 1, 0, 0, 0, 0, 0, 0]);</span></span>
<span class="line"><span style="color: #c9d1d9">    try conn.writeAll(response);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var wg = std.os.WaitGroup.init(2);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer wg.wait();</span></span>
<span class="line"><span style="color: #c9d1d9">    wg.add(1);</span></span>
<span class="line"><span style="color: #c9d1d9">    std.async.spawn(async (c: async.Task) void {</span></span>
<span class="line"><span style="color: #c9d1d9">        io.copy(server, conn);</span></span>
<span class="line"><span style="color: #c9d1d9">        conn.shutdown(net.SocketShutdown.Write);</span></span>
<span class="line"><span style="color: #c9d1d9">        wg.done();</span></span>
<span class="line"><span style="color: #c9d1d9">    });</span></span>
<span class="line"><span style="color: #c9d1d9">    wg.add(1);</span></span>
<span class="line"><span style="color: #c9d1d9">    std.async.spawn(async (c: async.Task) void {</span></span>
<span class="line"><span style="color: #c9d1d9">        io.copy(conn, server);</span></span>
<span class="line"><span style="color: #c9d1d9">        server.shutdown(net.SocketShutdown.Write);</span></span>
<span class="line"><span style="color: #c9d1d9">        wg.done();</span></span>
<span class="line"><span style="color: #c9d1d9">    });</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn main(args: [][]const u8) !void {</span></span>
<span class="line"><span style="color: #c9d1d9">    var laddr = try net.TcpAddress.parseIpPort("127.0.0.1", 8000, try std.heap.c_allocator);</span></span>
<span class="line"><span style="color: #c9d1d9">    var sock = try net.listen(laddr);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer sock.close();</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    std.debug.print("proxy: listening on ", .{laddr.repr()});</span></span>
<span class="line"><span style="color: #c9d1d9">    while (true) : (err) {</span></span>
<span class="line"><span style="color: #c9d1d9">        var (conn, _) = try sock.accept();</span></span>
<span class="line"><span style="color: #c9d1d9">        std.async.spawn(async (c: async.Task) void {</span></span>
<span class="line"><span style="color: #c9d1d9">            std.log.debug("accepted client");</span></span>
<span class="line"><span style="color: #c9d1d9">            defer conn.close();</span></span>
<span class="line"><span style="color: #c9d1d9">            try handleConnection(conn);</span></span>
<span class="line"><span style="color: #c9d1d9">        });</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span></code></pre>
<p>该代理程序同样开启一个UDP连接监听并接受来自客户端的socks5请求，解析请求参数获取目标服务器地址，然后建立与目标服务器的连接，对拷数据完成数据传输。在代码中，我们使用异步spawning处理多个连接。需要注意的一点是，Zig语言只在0.9.x版本之后支持Socket，因此编译时需要选择对应版本的编译器。</p>
<h2 id="user-4">user:</h2>
<p>python3实现sock5代理</p>
<h2 id="assistant-4">assistant:</h2>
<p>下面是一个使用Python3语言实现Sock5代理的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> socket</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> struct</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> sys</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> threading</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> select</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">handle_connection</span><span style="color: #C9D1D9">(conn):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 读取客户端版本信息</span></span>
<span class="line"><span style="color: #C9D1D9">    buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> conn.recv(</span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">not</span><span style="color: #C9D1D9"> buf:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 验证客户端版本协议，socks5版本号为05</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 回应客户端，可以使用无验证方式</span></span>
<span class="line"><span style="color: #C9D1D9">    conn.send(</span><span style="color: #FF7B72">b</span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\x05\x00</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 接收客户端请求</span></span>
<span class="line"><span style="color: #C9D1D9">    buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> conn.recv(</span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">not</span><span style="color: #C9D1D9"> buf:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 验证客户端请求协议，socks5协议规定连接方式为0x01，目的地址和端口号各占2个字节</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">or</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">or</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 获取目标地址和端口号</span></span>
<span class="line"><span style="color: #C9D1D9">    atyp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> socket.inet_ntoa(buf[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">:</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">        port </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> struct.unpack(</span><span style="color: #A5D6FF">">H"</span><span style="color: #C9D1D9">, buf[</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">:</span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9">])[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">elif</span><span style="color: #C9D1D9"> atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        addr_len </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">:</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">addr_len]</span></span>
<span class="line"><span style="color: #C9D1D9">        port </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> struct.unpack(</span><span style="color: #A5D6FF">">H"</span><span style="color: #C9D1D9">, buf[</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">addr_len:</span><span style="color: #79C0FF">7</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">addr_len])[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 连接目标服务器</span></span>
<span class="line"><span style="color: #C9D1D9">    server </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> socket.socket(socket.</span><span style="color: #79C0FF">AF_INET</span><span style="color: #C9D1D9">, socket.</span><span style="color: #79C0FF">SOCK_STREAM</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        server.connect((addr, port))</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">except</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    conn.send(</span><span style="color: #FF7B72">b</span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\x05\x00\x00\x01</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> socket.inet_aton(</span><span style="color: #A5D6FF">"0.0.0.0"</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> struct.pack(</span><span style="color: #A5D6FF">">H"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">))</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E"># 开始对拷数据</span></span>
<span class="line"><span style="color: #C9D1D9">    inputs </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [conn, server]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        r, w, e </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> select.select(inputs, [], [])</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> conn </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> r:</span></span>
<span class="line"><span style="color: #C9D1D9">            data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> conn.recv(</span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">not</span><span style="color: #C9D1D9"> data:</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span></span>
<span class="line"><span style="color: #C9D1D9">            server.send(data)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> server </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> r:</span></span>
<span class="line"><span style="color: #C9D1D9">            data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> server.recv(</span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">not</span><span style="color: #C9D1D9"> data:</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span></span>
<span class="line"><span style="color: #C9D1D9">            conn.send(data)</span></span>
<span class="line"><span style="color: #C9D1D9">    conn.close()</span></span>
<span class="line"><span style="color: #C9D1D9">    server.close()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">__name__</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"__main__"</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(sys.argv) </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Usage: python3 sock5.py listen_addr listen_port"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        sys.exit(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    laddr, lport </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> sys.argv[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], </span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9">(sys.argv[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">    s </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> socket.socket(socket.</span><span style="color: #79C0FF">AF_INET</span><span style="color: #C9D1D9">, socket.</span><span style="color: #79C0FF">SOCK_STREAM</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    s.bind((laddr, lport))</span></span>
<span class="line"><span style="color: #C9D1D9">    s.listen(</span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">f</span><span style="color: #A5D6FF">"proxy: listening on </span><span style="color: #79C0FF">{</span><span style="color: #C9D1D9">laddr</span><span style="color: #79C0FF">}</span><span style="color: #A5D6FF">:</span><span style="color: #79C0FF">{</span><span style="color: #C9D1D9">lport</span><span style="color: #79C0FF">}</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        conn, addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> s.accept()</span></span>
<span class="line"><span style="color: #C9D1D9">        threading.Thread(</span><span style="color: #FFA657">target</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">handle_connection, </span><span style="color: #FFA657">args</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(conn,)).start()</span></span></code></pre>
<p>该代理程序同样开启一个TCP连接监听并接受来自客户端的socks5请求，解析请求参数获取目标服务器地址，然后建立与目标服务器的连接，对拷数据完成数据传输。在代码中，使用Python3的select模块实现了IO多路复用，避免了单线程多客户端下的阻塞问题。</p>
<h2 id="user-5">user:</h2>
<p>php实现一个Sock5代理</p>
<h2 id="assistant-5">assistant:</h2>
<p>下面是一个使用PHP语言实现Sock5代理的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">&#x3C;?</span><span style="color: #79C0FF">php</span></span>
<span class="line"><span style="color: #8B949E">// 设置超时时间，单位秒</span></span>
<span class="line"><span style="color: #79C0FF">set_time_limit</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #8B949E">// 调整缓冲区大小</span></span>
<span class="line"><span style="color: #79C0FF">ini_set</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"output_buffering"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #79C0FF">ini_set</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"implicit_flush"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #79C0FF">ob_implicit_flush</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #8B949E">// 监听本地服务地址和端口</span></span>
<span class="line"><span style="color: #C9D1D9">$laddr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"127.0.0.1"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">$lport </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">8000</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">// 创建socket连接</span></span>
<span class="line"><span style="color: #C9D1D9">$sock </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket_create</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">AF_INET</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">SOCK_STREAM</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">SOL_TCP</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #8B949E">// 绑定到指定地址和端口</span></span>
<span class="line"><span style="color: #79C0FF">socket_bind</span><span style="color: #C9D1D9">($sock, $laddr, $lport);</span></span>
<span class="line"><span style="color: #8B949E">// 监听端口连接</span></span>
<span class="line"><span style="color: #79C0FF">socket_listen</span><span style="color: #C9D1D9">($sock);</span></span>
<span class="line"><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"proxy: listening on </span><span style="color: #C9D1D9">$laddr</span><span style="color: #A5D6FF">:</span><span style="color: #C9D1D9">$lport</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">PHP_EOL</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">// 处理连接请求</span></span>
<span class="line"><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 接受一个客户端连接</span></span>
<span class="line"><span style="color: #C9D1D9">    $conn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket_accept</span><span style="color: #C9D1D9">($sock);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 开启双向流传输</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">socket_set_nonblock</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 读取客户端版本信息</span></span>
<span class="line"><span style="color: #C9D1D9">    $buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_read</span><span style="color: #C9D1D9">($conn, </span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">$buf) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 验证客户端版本协议，socks5版本号为05</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ($buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 回应客户端，可以使用无验证方式</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">socket_write</span><span style="color: #C9D1D9">($conn, </span><span style="color: #79C0FF">b</span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\x05\x00</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 接收客户端请求</span></span>
<span class="line"><span style="color: #C9D1D9">    $buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_read</span><span style="color: #C9D1D9">($conn, </span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">$buf) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 验证客户端请求协议，socks5协议规定连接方式为0x01，目的地址和端口号各占2个字节</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ($buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> $buf[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> $buf[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 获取目标地址和端口号</span></span>
<span class="line"><span style="color: #C9D1D9">    $atyp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> $buf[</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ($atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        $addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">inet_ntoa</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">substr</span><span style="color: #C9D1D9">($buf, </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">        $port </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">unpack</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"n"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">substr</span><span style="color: #C9D1D9">($buf, </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">))[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">elseif</span><span style="color: #C9D1D9"> ($atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        $addr_len </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">ord</span><span style="color: #C9D1D9">($buf[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">]);</span></span>
<span class="line"><span style="color: #C9D1D9">        $addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">substr</span><span style="color: #C9D1D9">($buf, </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">, $addr_len);</span></span>
<span class="line"><span style="color: #C9D1D9">        $port </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">unpack</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"n"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">substr</span><span style="color: #C9D1D9">($buf, </span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">$addr_len, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">))[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 连接目标服务器</span></span>
<span class="line"><span style="color: #C9D1D9">    $server </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket_create</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">AF_INET</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">SOCK_STREAM</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">SOL_TCP</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!@</span><span style="color: #79C0FF">socket_connect</span><span style="color: #C9D1D9">($server, $addr, $port)) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($server);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 回应客户端</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">socket_write</span><span style="color: #C9D1D9">($conn, </span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\x05\x00\x00\x01</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">inet_pton</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"0.0.0.0"</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">pack</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"n"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 开始对拷数据</span></span>
<span class="line"><span style="color: #C9D1D9">    $input </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [$conn, $server];</span></span>
<span class="line"><span style="color: #C9D1D9">    $output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class="line"><span style="color: #C9D1D9">    $except </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">socket_select</span><span style="color: #C9D1D9">($input, $output, $except, </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">in_array</span><span style="color: #C9D1D9">($conn, $input)) {</span></span>
<span class="line"><span style="color: #C9D1D9">            $data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_read</span><span style="color: #C9D1D9">($conn, </span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">$data) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">socket_write</span><span style="color: #C9D1D9">($server, $data);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">in_array</span><span style="color: #C9D1D9">($server, $input)) {</span></span>
<span class="line"><span style="color: #C9D1D9">            $data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_read</span><span style="color: #C9D1D9">($server, </span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">$data) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">socket_write</span><span style="color: #C9D1D9">($conn, $data);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($conn);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">@</span><span style="color: #79C0FF">socket_close</span><span style="color: #C9D1D9">($server);</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>该代理程序同样开启一个TCP连接监听并接受来自客户端的socks5请求，解析请求参数获取目标服务器地址，然后建立与目标服务器的连接，对拷数据完成数据传输。在代码中，使用了PHP的socket库实现了socket连接、解析socks5请求和对拷数据的功能，并设置了非阻塞IO实现多客户端处理。</p>
<h2 id="user-6">user:</h2>
<p>C语言实现sock5代理</p>
<h2 id="assistant-6">assistant:</h2>
<p>下面是一个使用C语言实现Sock5代理的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;stdio.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;stdlib.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;string.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;errno.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;netdb.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;netinet/in.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;sys/types.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;sys/socket.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;arpa/inet.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;unistd.h></span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">handle_connection</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">conn</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">char</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> n;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 读取客户端版本信息</span></span>
<span class="line"><span style="color: #C9D1D9">    n </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(conn, buf, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(buf));</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (n </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 验证客户端版本协议，socks5版本号为05</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 回应客户端，可以使用无验证方式</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">write</span><span style="color: #C9D1D9">(conn, </span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\x05\x00</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 接收客户端请求</span></span>
<span class="line"><span style="color: #C9D1D9">    n </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(conn, buf, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(buf));</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (n </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 验证客户端请求协议，socks5协议规定连接方式为0x01，目的地址和端口号各占2个字节</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 获取目标地址和端口号</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> atyp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> sockaddr_in addr;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">memcpy</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr.sin_addr.s_addr, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">], </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">memcpy</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr.sin_port, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">], </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        addr.sin_family </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> AF_INET;</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> addr_len </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">char</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">hostname</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">memcpy</span><span style="color: #C9D1D9">(hostname, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">], addr_len);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">hostname</span><span style="color: #C9D1D9">[addr_len] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'</span><span style="color: #79C0FF">\0</span><span style="color: #A5D6FF">'</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">memcpy</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr.sin_port, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">buf</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">addr_len], </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        addr.sin_family </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> AF_INET;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> hostent </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">hptr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gethostbyname</span><span style="color: #C9D1D9">(hostname);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (hptr </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">memcpy</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr.sin_addr, hptr->h_addr, hptr->h_length);</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 连接目标服务器</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> server </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">socket</span><span style="color: #C9D1D9">(AF_INET, SOCK_STREAM, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (server </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(server, (</span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> sockaddr </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(addr)) </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">close</span><span style="color: #C9D1D9">(server);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 回应客户端</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">write</span><span style="color: #C9D1D9">(conn, </span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\x05\x00\x00\x01\x00\x00\x00\x00\x00\x00</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 开始对拷数据</span></span>
<span class="line"><span style="color: #C9D1D9">    fd_set input;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> maxfd;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">ssize_t</span><span style="color: #C9D1D9"> nbytes;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">char</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">bufrecv</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">FD_ZERO</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">input);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">FD_SET</span><span style="color: #C9D1D9">(conn, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">input);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">FD_SET</span><span style="color: #C9D1D9">(server, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">input);</span></span>
<span class="line"><span style="color: #C9D1D9">        maxfd </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (conn </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> server </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> conn </span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> server) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">select</span><span style="color: #C9D1D9">(maxfd, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">input, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">FD_ISSET</span><span style="color: #C9D1D9">(conn, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">input)) {</span></span>
<span class="line"><span style="color: #C9D1D9">            nbytes </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(conn, bufrecv, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(bufrecv));</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (nbytes </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">write</span><span style="color: #C9D1D9">(server, bufrecv, nbytes);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">FD_ISSET</span><span style="color: #C9D1D9">(server, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">input)) {</span></span>
<span class="line"><span style="color: #C9D1D9">            nbytes </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(server, bufrecv, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(bufrecv));</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (nbytes </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">write</span><span style="color: #C9D1D9">(conn, bufrecv, nbytes);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">close</span><span style="color: #C9D1D9">(conn);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">close</span><span style="color: #C9D1D9">(server);</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">argc</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">char</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #FFA657">argv</span><span style="color: #FF7B72">[]</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (argc </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Usage: </span><span style="color: #79C0FF">%s</span><span style="color: #A5D6FF"> listen_addr listen_port</span><span style="color: #79C0FF">\n</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">argv</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">exit</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">char</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">laddr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">argv</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> lport </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">atoi</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">argv</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> sock </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">socket</span><span style="color: #C9D1D9">(AF_INET, SOCK_STREAM, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (sock </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">perror</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"socket"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">exit</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> optval </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">setsockopt</span><span style="color: #C9D1D9">(sock, SOL_SOCKET, SO_REUSEADDR, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">optval, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(optval));</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> sockaddr_in addr;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">memset</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(addr));</span></span>
<span class="line"><span style="color: #C9D1D9">    addr.sin_family </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> AF_INET;</span></span>
<span class="line"><span style="color: #C9D1D9">    addr.sin_port </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">htons</span><span style="color: #C9D1D9">(lport);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">inet_pton</span><span style="color: #C9D1D9">(AF_INET, laddr, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr.sin_addr);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">bind</span><span style="color: #C9D1D9">(sock, (</span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> sockaddr </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">addr, </span><span style="color: #FF7B72">sizeof</span><span style="color: #C9D1D9">(addr)) </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">perror</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"bind"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">exit</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">listen</span><span style="color: #C9D1D9">(sock, </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">perror</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"listen"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">exit</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"proxy: listening on </span><span style="color: #79C0FF">%s</span><span style="color: #A5D6FF">:</span><span style="color: #79C0FF">%d\n</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">, laddr, lport);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> conn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">accept</span><span style="color: #C9D1D9">(sock, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (conn </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">fork</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">close</span><span style="color: #C9D1D9">(sock);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">handle_connection</span><span style="color: #C9D1D9">(conn);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">exit</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">close</span><span style="color: #C9D1D9">(conn);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">close</span><span style="color: #C9D1D9">(sock);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>该代理程序同样开启一个TCP连接监听并接受来自客户端的socks5请求，解析请求参数获取目标服务器地址，然后建立与目标服务器的连接，对拷数据完成数据传输。在代码中，使用了C语言的socket库实现了socket连接、解析socks5请求和对拷数据的功能，并使用了fork模型实现多客户端处理。</p>
<h2 id="user-7">user:</h2>
<p>Rust</p>
<h2 id="assistant-7">assistant:</h2>
<p>下面是一个使用Rust语言实现Sock5代理的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Error</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Read</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Result</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Write</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">net</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">TcpListener</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">TcpStream</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ToSocketAddrs</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">thread;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BUF_SIZE</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">handle_connection</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> conn</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TcpStream</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Result</span><span style="color: #C9D1D9">&#x3C;()> {</span></span>
<span class="line"><span style="color: #8B949E">    // 读取客户端版本信息</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">256</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> conn</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> buf)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Err</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Error</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ErrorKind</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Other</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"invalid header"</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #8B949E">    // 验证客户端版本协议，socks5版本号为05</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Err</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Error</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ErrorKind</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Other</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"invalid header"</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #8B949E">    // 回应客户端，可以使用无验证方式</span></span>
<span class="line"><span style="color: #C9D1D9">    conn</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">write_all</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">b"</span><span style="color: #79C0FF">\x05\x00</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">    // 接收客户端请求</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> conn</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> buf)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Err</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Error</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ErrorKind</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Other</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"invalid request"</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #8B949E">    // 验证客户端请求协议，socks5协议规定连接方式为0x01，目的地址和端口号各占2个字节</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Err</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Error</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ErrorKind</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Other</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"invalid request"</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #8B949E">    // 获取目标地址和端口号</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> atyp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> addr</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FF7B72">dyn</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ToSocketAddrs</span><span style="color: #C9D1D9">>;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">u32</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_be_bytes</span><span style="color: #C9D1D9">([buf[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">], buf[</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">], buf[</span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">], buf[</span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">]]);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> p </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">u16</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_be_bytes</span><span style="color: #C9D1D9">([buf[</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">], buf[</span><span style="color: #79C0FF">9</span><span style="color: #C9D1D9">]]);</span></span>
<span class="line"><span style="color: #C9D1D9">        addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">format!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"{}.{}.{}.{}:{}"</span><span style="color: #C9D1D9">, i </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0xFF</span><span style="color: #C9D1D9">, (i </span><span style="color: #FF7B72">>></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0xFF</span><span style="color: #C9D1D9">, (i </span><span style="color: #FF7B72">>></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">16</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0xFF</span><span style="color: #C9D1D9">, (i </span><span style="color: #FF7B72">>></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">24</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0xFF</span><span style="color: #C9D1D9">, p)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">parse</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">>()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">());</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> atyp </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> addr_len </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> buf[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> hostname </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">String</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_utf8_lossy</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">buf[</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">addr_len])</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_owned</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> p </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">u16</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_be_bytes</span><span style="color: #C9D1D9">([buf[</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">addr_len], buf[</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9">addr_len</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]]);</span></span>
<span class="line"><span style="color: #C9D1D9">        addr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">((hostname, p));</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Err</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Error</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ErrorKind</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Other</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"invalid request"</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #8B949E">    // 连接目标服务器</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> server </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TcpStream</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(addr</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">as_ref</span><span style="color: #C9D1D9">())</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">    // 回应客户端</span></span>
<span class="line"><span style="color: #C9D1D9">    conn</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">write_all</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">b"</span><span style="color: #79C0FF">\x05\x00\x00\x01\x00\x00\x00\x00\x00\x00</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">    // 开始对拷数据</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">BUF_SIZE</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">loop</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> input </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [conn</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">try_clone</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">, server</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">try_clone</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">select</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> input, </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> output, </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> output[i] {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">BUF_SIZE</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> nbytes </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> input[i]</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> data)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> nbytes </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(());</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">                input[</span><span style="color: #79C0FF">1</span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">i]</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">write_all</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">data[</span><span style="color: #FF7B72">..</span><span style="color: #C9D1D9">nbytes])</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(())</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">select</span><span style="color: #C9D1D9">(input</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">TcpStream</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">], output</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">bool</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">], timeout</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Option</span><span style="color: #C9D1D9">&#x3C;std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #C9D1D9">>) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Result</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> fds </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    fds[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> input[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">as_raw_fd</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    fds[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> input[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">as_raw_fd</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> timeout </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">match</span><span style="color: #C9D1D9"> timeout {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(t) </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">timespec {</span></span>
<span class="line"><span style="color: #C9D1D9">            tv_sec</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> t</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">as_secs</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">time_t,</span></span>
<span class="line"><span style="color: #C9D1D9">            tv_nsec</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> t</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">subsec_nanos</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">c_long,</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">timespec {</span></span>
<span class="line"><span style="color: #C9D1D9">            tv_sec</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            tv_nsec</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">    };</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> nfds </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">unsafe</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">pselect</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">            fds[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> fds[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*mut</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">c_int, </span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> fds[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*mut</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">c_int, </span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ptr</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">null_mut</span><span style="color: #C9D1D9">(), </span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> timeout </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*mut</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">timespec, </span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ptr</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">null</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">        )</span></span>
<span class="line"><span style="color: #C9D1D9">    };</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> nfds </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Err</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Error</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">last_os_error</span><span style="color: #C9D1D9">());</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        output[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> fds[i] </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">FD_ISSET</span><span style="color: #C9D1D9">(fds[i], </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">fds);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> output[i] {</span></span>
<span class="line"><span style="color: #C9D1D9">            n </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(n)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">#[inline]</span></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">FD_ISSET</span><span style="color: #C9D1D9">(fd</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">, fds</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">fd_set) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">unsafe</span><span style="color: #C9D1D9"> { (</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">fds</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">__fds_bits</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">as_ptr</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add</span><span style="color: #C9D1D9">(fd </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #79C0FF">NFDBITS</span><span style="color: #C9D1D9">)) </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x3C;&#x3C;</span><span style="color: #C9D1D9"> (fd </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">%</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #79C0FF">NFDBITS</span><span style="color: #C9D1D9">)) </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Result</span><span style="color: #C9D1D9">&#x3C;()> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> listener </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TcpListener</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">bind</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"127.0.0.1:8000"</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"proxy: listening on {}"</span><span style="color: #C9D1D9">, listener</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">local_addr</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> stream </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> listener</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">incoming</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> stream </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> stream</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> handle </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Err</span><span style="color: #C9D1D9">(e) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">handle_connection</span><span style="color: #C9D1D9">(stream) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"error: {}"</span><span style="color: #C9D1D9">, e);</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"><span style="color: #C9D1D9">        handle</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">join</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(())</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>该代理程序同样开启一个TCP连接监听并接受来自客户端的socks5请求，解析请求参数获取目标服务器地址，然后建立与目标服务器的连接，对拷数据完成数据传输。在代码中，使用了Rust的std库实现了socket连接、解析socks5请求和对拷数据的功能，并使用了pselect模型实现多客户端处理。</p>
<h2 id="user-8">user:</h2>
<p>sqlite3源代码分析</p>
<h2 id="assistant-8">assistant:</h2>
<p>SQLite是一个嵌入式关系型数据库管理系统，由于其轻量级、易用、高效等特点，在Android、iOS、Windows等操作系统中得到了广泛的应用。</p>
<p>SQLite的源代码分析需要涉及较为广泛的领域，主要包括操作系统、计算机网络、数据库、数据结构等。下面就SQLite的源代码进行简单的介绍。</p>
<p>SQLite整个代码结构非常清晰，主要包括以下几个部分：</p>
<ol>
<li>btree：B-Tree的实现代码，主要用于管理SQLite数据库中的索引和数据；</li>
<li>vdbe：虚拟机执行引擎的代码，用于执行SQLite SQL语句；</li>
<li>parse：解析器的代码；</li>
<li>os：操作系统相关的代码，包括文件IO、线程、内存分配等；</li>
<li>util：一些辅助工具类的代码；</li>
<li>src：SQLite库的核心代码，包括SQL语句的优化、解析、执行等。</li>
</ol>
<p>主要分析一下SQLite的SQL语句的执行过程。SQLite的SQL语句执行过程可以分为以下几个步骤：</p>
<ol>
<li>SQL语句解析：SQLite将SQL语句解析为一颗语法树，同时生成查询计划；</li>
<li>SQL语句优化：SQLite对查询计划进行优化，以提高SQL查询的效率；</li>
<li>SQL语句执行：SQLite按照优化后的查询计划执行SQL查询；</li>
<li>SQL查询结果处理：SQLite对查询结果进行处理，返回给用户或存储到本地磁盘等。</li>
</ol>
<p>其中，SQL语句解析和优化的过程在解析器解析SQL语句时便完成了，而SQL语句的执行包含多种类型的指令，对应着虚拟机中的不同操作码，虚拟机执行引擎负责根据优化后的查询计划解释执行SQL语句。</p>
<p>具体执行的步骤如下：</p>
<ol>
<li>初始化虚拟机，包括确定执行SQL语句的起始地址和终止地址，创建表达式堆栈和产生式堆栈等；</li>
<li>从数据库中获取数据，备份为可撤销的状态，以便之后恢复现场；</li>
<li>虚拟机执行SQL语句，包括数据的读取、处理和写入，以及产生式的执行等；</li>
<li>SQL语句执行结束，回滚到起始点，恢复现场。</li>
</ol>
<p>在虚拟执行过程中，每个操作码对应着一个具体的操作，例如OP_Column操作码表示取出数据库中某个字段的值，实现代码如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">// OP_Column操作</span></span>
<span class="line"><span style="color: #C9D1D9">case OP_Column: {</span><span style="color: #8B949E">            /* out2-prerelease */</span></span>
<span class="line"><span style="color: #C9D1D9">  Mem </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">p1;</span></span>
<span class="line"><span style="color: #C9D1D9">  BtCursor </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">pCrsr;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  pOut </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">out2Prerelease</span><span style="color: #C9D1D9">(p, pc);</span></span>
<span class="line"><span style="color: #C9D1D9">  pResult </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">aMem</span><span style="color: #C9D1D9">[p->aOp[pc].p2];</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( p->aOp[pc].p1</span><span style="color: #FF7B72">>=</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> p->aOp[pc].p1</span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">)p->nMem );</span></span>
<span class="line"><span style="color: #C9D1D9">  p1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">aMem</span><span style="color: #C9D1D9">[p->aOp[pc].p1];</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( </span><span style="color: #D2A8FF">memIsValid</span><span style="color: #C9D1D9">(p1) );</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( (p1->flags</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">(MEM_Blob</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">MEM_Str))</span><span style="color: #FF7B72">!=</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> ){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">sqlite3VdbeMemExpandBlob</span><span style="color: #C9D1D9">(p1);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( (p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> MEM_Zero) ){</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">memset</span><span style="color: #C9D1D9">(p1->z,p1->u.nZero,p1->n);</span></span>
<span class="line"><span style="color: #C9D1D9">      p1->flags </span><span style="color: #FF7B72">&#x26;=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">~</span><span style="color: #C9D1D9">MEM_Zero;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">UPDATE_MAX_BLOBSIZE</span><span style="color: #C9D1D9">(p1);</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> MEM_Null ){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">sqlite3VdbeMemSetNull</span><span style="color: #C9D1D9">(pOut);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( </span><span style="color: #D2A8FF">memIsValid</span><span style="color: #C9D1D9">(pResult) );</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( (p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> (MEM_Blob</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">MEM_Str))</span><span style="color: #FF7B72">==</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> p1->z </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> p1->n</span><span style="color: #FF7B72">==</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> );</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( p1->szMalloc</span><span style="color: #FF7B72">></span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> );</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> MEM_Dyn );</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> (MEM_Blob</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">MEM_Str) );</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( (p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> MEM_Zero) ){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">memset</span><span style="color: #C9D1D9">(p1->z,p1->u.nZero,p1->n);</span></span>
<span class="line"><span style="color: #C9D1D9">    p1->flags </span><span style="color: #FF7B72">&#x26;=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">~</span><span style="color: #C9D1D9">MEM_Zero;</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( pOp->p3 ){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( pIn1</span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9">aMem </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> pIn1</span><span style="color: #FF7B72">&#x3C;&#x26;</span><span style="color: #FFA657">aMem</span><span style="color: #C9D1D9">[db->nMem] );</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( </span><span style="color: #D2A8FF">memIsValid</span><span style="color: #C9D1D9">(pIn1) );</span></span>
<span class="line"><span style="color: #C9D1D9">    pCrsr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (BtCursor </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">)pOp->p3;</span></span>
<span class="line"><span style="color: #C9D1D9">    iReq </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">sqlite3BtreeMovetoUnpacked</span><span style="color: #C9D1D9">(pCrsr,</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,pIn1,nKey,</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">res);</span></span>
<span class="line"><span style="color: #C9D1D9">    r1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">p->aMem[pOp->p1];</span></span>
<span class="line"><span style="color: #FF7B72">#ifdef</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">SQLITE_DEBUG</span></span>
<span class="line"><span style="color: #C9D1D9">    r1->pScopyFrom </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">#endif</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( iReq</span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9">SQLITE_OK ) </span><span style="color: #FF7B72">goto</span><span style="color: #C9D1D9"> abort_due_to_error;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( res</span><span style="color: #FF7B72">==</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> ){</span></span>
<span class="line"><span style="color: #C9D1D9">      r1->flags </span><span style="color: #FF7B72">&#x26;=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">~</span><span style="color: #C9D1D9">MEM_Null;</span></span>
<span class="line"><span style="color: #C9D1D9">      rc </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">sqlite3BtreeRetrieve</span><span style="color: #C9D1D9">(pCrsr, (u32)</span><span style="color: #FFA657">w</span><span style="color: #C9D1D9">[i</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], r1);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( rc</span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9">SQLITE_OK </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> (r1->flags</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">MEM_Null) );</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">UPDATE_MAX_BLOBSIZE</span><span style="color: #C9D1D9">(r1);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( rc ) </span><span style="color: #FF7B72">goto</span><span style="color: #C9D1D9"> abort_due_to_error;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">sqlite3VdbeMemSetNull</span><span style="color: #C9D1D9">(r1);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> MEM_Blob ){</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( </span><span style="color: #D2A8FF">ExpandBlob</span><span style="color: #C9D1D9">(p1) ) </span><span style="color: #FF7B72">goto</span><span style="color: #C9D1D9"> no_mem;</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">( p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> MEM_Zero ){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">memset</span><span style="color: #C9D1D9">(p1->z,p1->u.nZero,p1->n);</span></span>
<span class="line"><span style="color: #C9D1D9">        p1->flags </span><span style="color: #FF7B72">&#x26;=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">~</span><span style="color: #C9D1D9">MEM_Zero;</span></span>
<span class="line"><span style="color: #C9D1D9">      }</span></span>
<span class="line"><span style="color: #FF7B72">#ifdef</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">SQLITE_DEBUG</span></span>
<span class="line"><span style="color: #C9D1D9">      p1->flags;</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Debugging check.  This will catch a specific type of error where</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// the string that ought to be a database BLOB contains embedded</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// '\0' characters.</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( (p1->flags </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> MEM_Zero)</span><span style="color: #FF7B72">==</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">sqlite3_value_type</span><span style="color: #C9D1D9">(p1)</span><span style="color: #FF7B72">&#x3C;</span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9"> );</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( p1->z </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> p1->n</span><span style="color: #FF7B72">==</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> );</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert</span><span style="color: #C9D1D9">( </span><span style="color: #D2A8FF">VdbeMemDynamic</span><span style="color: #C9D1D9">(p1)</span><span style="color: #FF7B72">==</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> );</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">sqlite3VdbeMemShallowCopy</span><span style="color: #C9D1D9">(pOut, p1, MEM_Ephem);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">REGISTER_TRACE</span><span style="color: #C9D1D9">(pOp->p2, pOut);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>可以看出，虚拟机执行时，会根据不同的操作码执行不同的操作，例如获取字段的值操作，可以使用Btree库的Cursor进行实现。虚拟机也使用了一些中间变量、栈式结构、分支等基本语言结构，以便更好地实现SQL语句的执行。</p>
<p>除了虚拟机执行引擎代码外，还存在一些操作系统相关的代码，例如os_unix.c文件，主要实现与文件I/O、线程、内存分配等相关的功能。这些代码负责实现不同的平台下的SQLite数据库管理系统。</p>
<p>需要注意的是，SQLite作为一个嵌入式数据库管理系统，其代码并不极其复杂，但涉及到的领域比较广泛，需要对操作系统和计算机网络等有一定的了解才能搞懂其代码。</p>
<h2 id="user-9">user:</h2>
<p>zig实现一个http服务器</p>
<h2 id="assistant-9">assistant:</h2>
<p>Zig是一门静态类型、本地编译的编程语言，可视作一种“现代化C语言”，具有易学、易用、高效等特点。</p>
<p>以下是使用Zig语言实现简单的HTTP服务器的步骤：</p>
<ol>
<li>创建TCP/IP服务器：使用Zig的std.net.tcp.Listener模块创建一个TCP服务器监听端口，处理客户端的请求。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">const ipaddress = @import("std").net.ipaddress;</span></span>
<span class="line"><span style="color: #c9d1d9">const tcp = @import("std").net.tcp;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn main() !void {</span></span>
<span class="line"><span style="color: #c9d1d9">    var gpa = try ipaddress.parse("127.0.0.1", .{});</span></span>
<span class="line"><span style="color: #c9d1d9">    var listeningAddress = gpa.payload.any.ipv4;</span></span>
<span class="line"><span style="color: #c9d1d9">    var listener = try tcp.Listener.bindAddress(listeningAddress, 8080);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer listener.close();</span></span>
<span class="line"><span style="color: #c9d1d9">    const pr = try tcp.poller.create(1);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer pr.deinit();</span></span>
<span class="line"><span style="color: #c9d1d9">    var events = [_]tcp.PollEvent{undefined};</span></span>
<span class="line"><span style="color: #c9d1d9">    const TIMEOUT_MS: u64 = 1000;</span></span>
<span class="line"><span style="color: #c9d1d9">    while (true) {</span></span>
<span class="line"><span style="color: #c9d1d9">        if (try pr.poll(&#x26;events, TIMEOUT_MS)) |event| {</span></span>
<span class="line"><span style="color: #c9d1d9">            if (event.id == listener.raw.fd) {</span></span>
<span class="line"><span style="color: #c9d1d9">                const conn = try listener.accept();</span></span>
<span class="line"><span style="color: #c9d1d9">                defer conn.close();</span></span>
<span class="line"><span style="color: #c9d1d9">                //处理客户端请求</span></span>
<span class="line"><span style="color: #c9d1d9">            }</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span></code></pre>
<ol start="2">
<li>处理客户端请求：在接收到客户端连接后，从连接中读取HTTP请求报文，解析报文中的请求路径和其他相关信息，处理请求并向客户端发送HTTP响应报文。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">pub fn handle_request(conn: std.net.tcp.Connector) !void {</span></span>
<span class="line"><span style="color: #c9d1d9">    const buffer_size: usize = 1024;</span></span>
<span class="line"><span style="color: #c9d1d9">    var buffer: [buffer_size]u8 = undefined;</span></span>
<span class="line"><span style="color: #c9d1d9">    const pr = try tcp.poller.create(1);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer pr.deinit();</span></span>
<span class="line"><span style="color: #c9d1d9">    var events = [_]tcp.PollEvent{undefined};</span></span>
<span class="line"><span style="color: #c9d1d9">    while (true) {</span></span>
<span class="line"><span style="color: #c9d1d9">        try conn.poll_readable(true);</span></span>
<span class="line"><span style="color: #c9d1d9">        try conn.poll_writeable(true);</span></span>
<span class="line"><span style="color: #c9d1d9">        if (try pr.poll(&#x26;events, TIMEOUT_MS)) |event| {</span></span>
<span class="line"><span style="color: #c9d1d9">            if (event.id == conn.raw.fd) {</span></span>
<span class="line"><span style="color: #c9d1d9">                const num_read = try conn.reader().read(buffer[0..buffer_size]);</span></span>
<span class="line"><span style="color: #c9d1d9">                if (num_read == 0) {</span></span>
<span class="line"><span style="color: #c9d1d9">                    break;</span></span>
<span class="line"><span style="color: #c9d1d9">                } else {</span></span>
<span class="line"><span style="color: #c9d1d9">                    const req = std.http.request.parse(buffer[0..num_read]);</span></span>
<span class="line"><span style="color: #c9d1d9">                    if (req.status == .bad_request) {</span></span>
<span class="line"><span style="color: #c9d1d9">                        //处理异常情况</span></span>
<span class="line"><span style="color: #c9d1d9">                    }</span></span>
<span class="line"><span style="color: #c9d1d9">                    const buf_writer = try conn.writer().bufferWriter();</span></span>
<span class="line"><span style="color: #c9d1d9">                    defer buf_writer.flush();</span></span>
<span class="line"><span style="color: #c9d1d9">                    //构造HTTP响应报文</span></span>
<span class="line"><span style="color: #c9d1d9">                    const content = "Hello, world!";</span></span>
<span class="line"><span style="color: #c9d1d9">                    const response = std.http.response.build(.{</span></span>
<span class="line"><span style="color: #c9d1d9">                        .status_code = .ok,</span></span>
<span class="line"><span style="color: #c9d1d9">                        .header_set = .{</span></span>
<span class="line"><span style="color: #c9d1d9">                            .reserve(1),</span></span>
<span class="line"><span style="color: #c9d1d9">                            .appendHeader(.{</span></span>
<span class="line"><span style="color: #c9d1d9">                                .name = @[]u8("Content-Length"),</span></span>
<span class="line"><span style="color: #c9d1d9">                                .value = std.fmt.itoa(u29, content.len),</span></span>
<span class="line"><span style="color: #c9d1d9">                            }),</span></span>
<span class="line"><span style="color: #c9d1d9">                        },</span></span>
<span class="line"><span style="color: #c9d1d9">                        .body = content,</span></span>
<span class="line"><span style="color: #c9d1d9">                    });</span></span>
<span class="line"><span style="color: #c9d1d9">                    try response.serialize(buf_writer.writer());</span></span>
<span class="line"><span style="color: #c9d1d9">                }</span></span>
<span class="line"><span style="color: #c9d1d9">            }</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span></code></pre>
<p>在构造HTTP响应报文时，需要注意响应报文的格式与HTTP协议规范相符，例如响应报头格式、响应报文Body格式等。</p>
<ol start="3">
<li>完整的代码</li>
</ol>
<p>以下是基于Zig语言实现的简单HTTP服务器的完整代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">const ipaddress = @import("std").net.ipaddress;</span></span>
<span class="line"><span style="color: #c9d1d9">const tcp = @import("std").net.tcp;</span></span>
<span class="line"><span style="color: #c9d1d9">const time = @import("std").time;</span></span>
<span class="line"><span style="color: #c9d1d9">const fmt = @import("std").fmt;</span></span>
<span class="line"><span style="color: #c9d1d9">const http = @import("std").http;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">const TIMEOUT_MS: u32 = 500;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn handle_request(conn: std.net.tcp.Connector) !void {</span></span>
<span class="line"><span style="color: #c9d1d9">    const buffer_size: usize = 1024;</span></span>
<span class="line"><span style="color: #c9d1d9">    var buffer: [buffer_size]u8 = undefined;</span></span>
<span class="line"><span style="color: #c9d1d9">    const pr = try tcp.poller.create(1);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer pr.deinit();</span></span>
<span class="line"><span style="color: #c9d1d9">    var events = [_]tcp.PollEvent{undefined};</span></span>
<span class="line"><span style="color: #c9d1d9">    while (true) {</span></span>
<span class="line"><span style="color: #c9d1d9">        try conn.poll_readable(true);</span></span>
<span class="line"><span style="color: #c9d1d9">        try conn.poll_writeable(true);</span></span>
<span class="line"><span style="color: #c9d1d9">        if (try pr.poll(&#x26;events, TIMEOUT_MS)) |event| {</span></span>
<span class="line"><span style="color: #c9d1d9">            if (event.id == conn.raw.fd) {</span></span>
<span class="line"><span style="color: #c9d1d9">                const num_read = try conn.reader().read(buffer[0..buffer_size]);</span></span>
<span class="line"><span style="color: #c9d1d9">                if (num_read == 0) {</span></span>
<span class="line"><span style="color: #c9d1d9">                    break;</span></span>
<span class="line"><span style="color: #c9d1d9">                } else {</span></span>
<span class="line"><span style="color: #c9d1d9">                    const req = std.http.request.parse(buffer[0..num_read]);</span></span>
<span class="line"><span style="color: #c9d1d9">                    if (req.status == .bad_request) {</span></span>
<span class="line"><span style="color: #c9d1d9">                        continue;</span></span>
<span class="line"><span style="color: #c9d1d9">                    }</span></span>
<span class="line"><span style="color: #c9d1d9">                    const buf_writer = try conn.writer().bufferWriter();</span></span>
<span class="line"><span style="color: #c9d1d9">                    defer buf_writer.flush();</span></span>
<span class="line"><span style="color: #c9d1d9">                    const content = "Hello, world!";</span></span>
<span class="line"><span style="color: #c9d1d9">                    const response = std.http.response.build(.{</span></span>
<span class="line"><span style="color: #c9d1d9">                        .status_code = .ok,</span></span>
<span class="line"><span style="color: #c9d1d9">                        .header_set = .{</span></span>
<span class="line"><span style="color: #c9d1d9">                            .reserve(1),</span></span>
<span class="line"><span style="color: #c9d1d9">                            .appendHeader(.{</span></span>
<span class="line"><span style="color: #c9d1d9">                                .name = @[]u8("Content-Type"),</span></span>
<span class="line"><span style="color: #c9d1d9">                                .value = @[]u8("text/plain"),</span></span>
<span class="line"><span style="color: #c9d1d9">                            }),</span></span>
<span class="line"><span style="color: #c9d1d9">                            .appendHeader(.{</span></span>
<span class="line"><span style="color: #c9d1d9">                                .name = @[]u8("Content-Length"),</span></span>
<span class="line"><span style="color: #c9d1d9">                                .value = std.fmt.itoa(u29, content.len),</span></span>
<span class="line"><span style="color: #c9d1d9">                            }),</span></span>
<span class="line"><span style="color: #c9d1d9">                        },</span></span>
<span class="line"><span style="color: #c9d1d9">                        .body = content,</span></span>
<span class="line"><span style="color: #c9d1d9">                    });</span></span>
<span class="line"><span style="color: #c9d1d9">                    try response.serialize(buf_writer.writer());</span></span>
<span class="line"><span style="color: #c9d1d9">                }</span></span>
<span class="line"><span style="color: #c9d1d9">            }</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn main() ! void {</span></span>
<span class="line"><span style="color: #c9d1d9">    var gpa = try ipaddress.parse("0.0.0.0", .{});</span></span>
<span class="line"><span style="color: #c9d1d9">    var listeningAddress = gpa.payload.any.ipv4;</span></span>
<span class="line"><span style="color: #c9d1d9">    var listener = try tcp.Listener.bindAddress(listeningAddress, 8080);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer listener.close();</span></span>
<span class="line"><span style="color: #c9d1d9">    const pr = try tcp.poller.create(1);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer pr.deinit();</span></span>
<span class="line"><span style="color: #c9d1d9">    var events = [_]tcp.PollEvent{undefined};</span></span>
<span class="line"><span style="color: #c9d1d9">    while (true) {</span></span>
<span class="line"><span style="color: #c9d1d9">        if (try pr.poll(&#x26;events, TIMEOUT_MS)) |event| {</span></span>
<span class="line"><span style="color: #c9d1d9">            if (event.id == listener.raw.fd) {</span></span>
<span class="line"><span style="color: #c9d1d9">                const conn = try listener.accept();</span></span>
<span class="line"><span style="color: #c9d1d9">                defer conn.close();</span></span>
<span class="line"><span style="color: #c9d1d9">                try handle_request(conn);</span></span>
<span class="line"><span style="color: #c9d1d9">            }</span></span>
<span class="line"><span style="color: #c9d1d9">        }</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span></code></pre>
<p>通过以上简单的代码示例，我们可以看到使用Zig语言实现HTTP服务器的过程非常简单，代码量不大，同时这也是Zig语言充分体现出“易学、易用、高效”的特点。</p>
<h2 id="user-10">user:</h2>
<p>go语言实现回溯算法</p>
<h2 id="assistant-10">assistant:</h2>
<p>回溯算法是一种经典的计算机算法，通常被用于解决各种组合、排列、搜索等问题。以下是使用Go语言实现回溯算法的基本步骤：</p>
<ol>
<li>确定问题模型：首先需要确定问题模型以及需要返回的结果类型，例如求解N皇后问题的解。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Solution</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">string</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">SolveNQueens</span><span style="color: #C9D1D9">(n </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []Solution {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<ol start="2">
<li>
<p>实现回溯函数：接下来需要实现回溯函数，该函数通常包含以下基本步骤：</p>
<ul>
<li>检查是否达到目标状态，如果是则将当前状态添加至结果集中。</li>
<li>对当前状态进行扩展，即生成下一层的状态。</li>
<li>检查当前状态是否合法，如果合法则继续生成下一层状态，如果不合法则回溯到上一层状态，继续尝试其他选择。</li>
</ul>
</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">backtrack</span><span style="color: #C9D1D9">(n </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, row </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, cols, diags1, diags2 []</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, cur []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, res </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">[]Solution) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> row </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> n {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// 达成目标状态，将结果保存起来</span></span>
<span class="line"><span style="color: #C9D1D9">        board </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">string</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, col </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> cur {</span></span>
<span class="line"><span style="color: #C9D1D9">            line </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> strings.</span><span style="color: #79C0FF">Repeat</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"."</span><span style="color: #C9D1D9">, col) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"Q"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> strings.</span><span style="color: #79C0FF">Repeat</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"."</span><span style="color: #C9D1D9">, n</span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">col</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            board </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(board, line)</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">res </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">res, board)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> col </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; col </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> n; col</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        diag1 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> row </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> col </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">        diag2 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> row </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> col</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">cols[col] </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">diags1[diag1] </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">diags2[diag2] {</span></span>
<span class="line"><span style="color: #C9D1D9">            cols[col] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            diags1[diag1] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            diags2[diag2] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            cur[row] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> col</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">backtrack</span><span style="color: #C9D1D9">(n, row</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, cols, diags1, diags2, cur, res)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">            cols[col] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">            diags1[diag1] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">            diags2[diag2] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">SolveNQueens</span><span style="color: #C9D1D9">(n </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []Solution {</span></span>
<span class="line"><span style="color: #C9D1D9">    res </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []Solution{}</span></span>
<span class="line"><span style="color: #C9D1D9">    cur </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, n)</span></span>
<span class="line"><span style="color: #C9D1D9">    cols </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, n)</span></span>
<span class="line"><span style="color: #C9D1D9">    diags1 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">n</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    diags2 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">n</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">backtrack</span><span style="color: #C9D1D9">(n, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, cols, diags1, diags2, cur, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">res)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> res</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>以上代码实现了N皇后问题的求解函数，其中backtrack函数实现了回溯算法的核心部分：在每次扩展状态后，检查当前状态是否符合要求，如果符合，则继续生成下一层状态，否则回溯到上一层状态进行其他选择。</p>
<ol start="3">
<li>在主函数中调用回溯函数，输出结果。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    res </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SolveNQueens</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, sol </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> res {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, line </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> sol {</span></span>
<span class="line"><span style="color: #C9D1D9">            fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(line)</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>完整的代码示例如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">strings</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Solution</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">string</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">backtrack</span><span style="color: #C9D1D9">(n </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, row </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, cols, diags1, diags2 []</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, cur []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, res </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">[]Solution) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> row </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> n {</span></span>
<span class="line"><span style="color: #C9D1D9">        board </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">string</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, col </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> cur {</span></span>
<span class="line"><span style="color: #C9D1D9">            line </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> strings.</span><span style="color: #79C0FF">Repeat</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"."</span><span style="color: #C9D1D9">, col) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"Q"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> strings.</span><span style="color: #79C0FF">Repeat</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"."</span><span style="color: #C9D1D9">, n</span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">col</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            board </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(board, line)</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">res </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">res, board)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> col </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; col </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> n; col</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        diag1 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> row </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> col </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">        diag2 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> row </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> col</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">cols[col] </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">diags1[diag1] </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">diags2[diag2] {</span></span>
<span class="line"><span style="color: #C9D1D9">            cols[col] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            diags1[diag1] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            diags2[diag2] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            cur[row] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> col</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">backtrack</span><span style="color: #C9D1D9">(n, row</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, cols, diags1, diags2, cur, res)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">            cols[col] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">            diags1[diag1] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">            diags2[diag2] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">SolveNQueens</span><span style="color: #C9D1D9">(n </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []Solution {</span></span>
<span class="line"><span style="color: #C9D1D9">    res </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []Solution{}</span></span>
<span class="line"><span style="color: #C9D1D9">    cur </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, n)</span></span>
<span class="line"><span style="color: #C9D1D9">    cols </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, n)</span></span>
<span class="line"><span style="color: #C9D1D9">    diags1 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">n</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    diags2 </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">n</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">backtrack</span><span style="color: #C9D1D9">(n, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, cols, diags1, diags2, cur, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">res)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> res</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    res </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SolveNQueens</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, sol </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> res {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, line </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> sol {</span></span>
<span class="line"><span style="color: #C9D1D9">            fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(line)</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>通过以上实现，可以看到使用Go语言实现回溯算法也非常简单，通过实现回溯函数，再在主函数中调用即可完成问题求解。</p>
<h2 id="user-11">user:</h2>
<p>实现动态规划</p>
<h2 id="assistant-11">assistant:</h2>
<p>动态规划是一种算法思想，其核心思想是将问题分解成多个子问题，并且记录每个子问题的解以避免重复计算，从而优化计算的效率。以下是使用Go语言实现一个简单的动态规划算法的步骤：</p>
<ol>
<li>确定问题模型和状态转移方程：首先需要确定解决的问题、需要返回的结果类型，以及问题的状态转移方程，例如，给定一个无序数组，求解其最长上升子序列。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">LengthOfLIS</span><span style="color: #C9D1D9">(nums []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<ol start="2">
<li>实现动态规划算法：在实现动态规划算法时，需要首先定义问题的状态，即通过问题的状态转移方程来描述问题。设dp[i]为以i结尾的最长上升子序列的长度，则状态转移方程为：</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">dp[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">max</span><span style="color: #C9D1D9">(dp[j] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) (</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x3C;=</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> i, nums[j] </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> nums[i])</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">LengthOfLIS</span><span style="color: #C9D1D9">(nums []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    n </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(nums)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    dp </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, n)</span></span>
<span class="line"><span style="color: #C9D1D9">    dp[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">    maxLen </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> n; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        dp[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> i; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> nums[j] </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> nums[i] {</span></span>
<span class="line"><span style="color: #C9D1D9">                dp[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">max</span><span style="color: #C9D1D9">(dp[i], dp[j]</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        maxLen </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">max</span><span style="color: #C9D1D9">(maxLen, dp[i])</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> maxLen</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">max</span><span style="color: #C9D1D9">(a, b </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> a </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> b {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> a</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> b</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>以上代码实现了最长上升子序列问题的动态规划算法，其中使用了一个数组dp，表示以每个元素结尾的最长上升子序列的长度，最后返回其中的最大值。</p>
<ol start="3">
<li>在主函数中调用动态规划算法，输出结果。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    nums </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">9</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">101</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">18</span><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #C9D1D9">    res </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">LengthOfLIS</span><span style="color: #C9D1D9">(nums)</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(res)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>完整的代码示例如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">LengthOfLIS</span><span style="color: #C9D1D9">(nums []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    n </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(nums)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    dp </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, n)</span></span>
<span class="line"><span style="color: #C9D1D9">    dp[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">    maxLen </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> n; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        dp[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> i; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> nums[j] </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> nums[i] {</span></span>
<span class="line"><span style="color: #C9D1D9">                dp[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">max</span><span style="color: #C9D1D9">(dp[i], dp[j]</span><span style="color: #FF7B72">+</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        maxLen </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">max</span><span style="color: #C9D1D9">(maxLen, dp[i])</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> maxLen</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">max</span><span style="color: #C9D1D9">(a, b </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> a </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> b {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> a</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> b</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    nums </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">9</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">101</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">18</span><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #C9D1D9">    res </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">LengthOfLIS</span><span style="color: #C9D1D9">(nums)</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(res)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>通过以上实现，我们可以看到使用Go语言实现动态规划算法的过程非常简单，只需要定义好问题的状态和状态转移方程，再按照动态规划的思路实现即可。</p>
<h2 id="user-12">user:</h2>
<p>深度优先</p>
<h2 id="assistant-12">assistant:</h2>
<p>深度优先搜索（Depth-First Search，DFS）是一种常用的图形搜索算法，其通常使用递归或栈来实现。以下是使用Go语言实现深度优先搜索的基本步骤：</p>
<ol>
<li>定义问题模型：首先需要确定问题模型以及需要返回的结果类型，例如在无向图中查找从起点到终点的路径。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Graph</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    nodes [][]</span><span style="color: #FF7B72">int</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">FindPath</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, start, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<ol start="2">
<li>实现深度优先搜索算法：在实现深度优先搜索算法时，需要首先定义一个visited数组，用于标记每个节点是否已经被访问过；接下来，需要根据问题模型和操作定义深度优先搜索函数，其中在处理每个节点时需要逐个访问其邻居节点。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">dfs</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, cur </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, visited []</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, path </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">[]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    visited[cur] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path, cur)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> cur </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> end {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, neighbor </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> graph.nodes[cur] {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">visited[neighbor] {</span></span>
<span class="line"><span style="color: #C9D1D9">            found </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">dfs</span><span style="color: #C9D1D9">(graph, neighbor, end, visited, path)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> found {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path)[:</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path)</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">FindPath</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, start, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    visited </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">dfs</span><span style="color: #C9D1D9">(graph, start, end, visited, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">path)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> path</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>以上代码实现了无向图中查找从起点到终点路径的DFS算法，其中使用visited数组标记每个节点是否已被访问过，在处理每个节点时逐个访问其邻居节点，并将路径保存至path数组中。</p>
<ol start="3">
<li>在主函数中调用DFS算法，输出结果。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    graph </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">Graph{</span></span>
<span class="line"><span style="color: #C9D1D9">        nodes: [][]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">FindPath</span><span style="color: #C9D1D9">(graph, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(path)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>完整的代码示例如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Graph</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    nodes [][]</span><span style="color: #FF7B72">int</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">dfs</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, cur </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, visited []</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, path </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">[]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    visited[cur] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path, cur)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> cur </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> end {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, neighbor </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> graph.nodes[cur] {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">visited[neighbor] {</span></span>
<span class="line"><span style="color: #C9D1D9">            found </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">dfs</span><span style="color: #C9D1D9">(graph, neighbor, end, visited, path)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> found {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path)[:</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">path)</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">FindPath</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, start, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    visited </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">dfs</span><span style="color: #C9D1D9">(graph, start, end, visited, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">path)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> path</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    graph </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">Graph{</span></span>
<span class="line"><span style="color: #C9D1D9">        nodes: [][]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">FindPath</span><span style="color: #C9D1D9">(graph, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(path)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>通过以上实现，我们可以看到使用Go语言实现深度优先搜索的过程也非常简单，只需要根据问题模型和操作实现深度优先搜索算法即可。</p>
<h2 id="user-13">user:</h2>
<p>广度优先</p>
<h2 id="assistant-13">assistant:</h2>
<p>广度优先搜索</p>
<h2 id="user-14">user:</h2>
<p>广度优先算法</p>
<h2 id="assistant-14">assistant:</h2>
<p>广度优先搜索（Breadth-First Search，BFS）是一种图形搜索算法，其通常使用队列实现。以下是使用Go语言实现广度优先搜索的基本步骤：</p>
<ol>
<li>定义问题模型：首先需要确定问题模型以及需要返回的结果类型，例如在无向图中查找从起点到终点的最短路径。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Graph</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    nodes [][]</span><span style="color: #FF7B72">int</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">FindPath</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, start, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<ol start="2">
<li>实现广度优先搜索算法：在实现广度优先搜索算法时，需要首先定义一个visited数组，用于标记每个节点是否已经被访问过；接下来，需要定义一个队列，用于存储当前需要访问的节点以及与其相邻的所有节点，其中需要引入一个辅助的距离数组，用于记录每个节点到起点的距离，以便在最终返回最短路径时使用。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">FindPath</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, start, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    visited </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    queue </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{start}</span></span>
<span class="line"><span style="color: #C9D1D9">    distance </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    parent </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    visited[start] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(queue) </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        cur </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> queue[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        queue </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> queue[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">:]</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, neighbor </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> graph.nodes[cur] {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">visited[neighbor] {</span></span>
<span class="line"><span style="color: #C9D1D9">                visited[neighbor] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">                queue </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(queue, neighbor)</span></span>
<span class="line"><span style="color: #C9D1D9">                distance[neighbor] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> distance[cur] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">                parent[neighbor] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cur</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">visited[end] {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{end}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> cur </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> end; cur </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> start; cur </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> parent[cur] {</span></span>
<span class="line"><span style="color: #C9D1D9">        path </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{parent[cur]}, path</span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> path</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>以上代码实现了无向图中查找从起点到终点的最短路径算法。其中使用visited数组标记每个节点是否已被访问过，在处理每个节点时将其所有邻居节点加入队列中，并根据距离数组记录每个节点到起点的距离，以便在返回最短路径时使用。</p>
<ol start="3">
<li>在主函数中调用BFS算法，输出结果。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    graph </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">Graph{</span></span>
<span class="line"><span style="color: #C9D1D9">        nodes: [][]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">FindPath</span><span style="color: #C9D1D9">(graph, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(path)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>完整的代码示例如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Graph</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    nodes [][]</span><span style="color: #FF7B72">int</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">FindPath</span><span style="color: #C9D1D9">(graph </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">Graph, start, end </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    visited </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    queue </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{start}</span></span>
<span class="line"><span style="color: #C9D1D9">    distance </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    parent </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(graph.nodes))</span></span>
<span class="line"><span style="color: #C9D1D9">    visited[start] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(queue) </span><span style="color: #FF7B72">></span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        cur </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> queue[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        queue </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> queue[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">:]</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _, neighbor </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">range</span><span style="color: #C9D1D9"> graph.nodes[cur] {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">visited[neighbor] {</span></span>
<span class="line"><span style="color: #C9D1D9">                visited[neighbor] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">                queue </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">(queue, neighbor)</span></span>
<span class="line"><span style="color: #C9D1D9">                distance[neighbor] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> distance[cur] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">                parent[neighbor] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cur</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">visited[end] {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> []</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{end}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> cur </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> end; cur </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> start; cur </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> parent[cur] {</span></span>
<span class="line"><span style="color: #C9D1D9">        path </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">append</span><span style="color: #C9D1D9">([]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{parent[cur]}, path</span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> path</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    graph </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">Graph{</span></span>
<span class="line"><span style="color: #C9D1D9">        nodes: [][]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    path </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">FindPath</span><span style="color: #C9D1D9">(graph, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(path)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>通过以上实现，我们可以看到使用Go语言实现广度优先搜索的过程也非常简单，只需要根据问题模型和操作实现广度优先搜索算法即可。</p>
<h2 id="user-15">user:</h2>
<p>最短路径</p>
<h2 id="assistant-15">assistant:</h2>
<p>最短路径指的是图中两个节点之间的最短距离，其中“距离”可以是边长，也可以是边权（具有关联性的数字）之和。最短路径算法是图论中的重要问题，多用于网络路由、电路布线等领域。最短路径算法的经典算法有Dijkstra算法和Floyd算法。</p>
<p>Dijkstra算法指的是从起点到所有节点的最短路径算法。它的核心思想是贪心，具体来说，就是每次从尚未处理的节点中选取目前的路径值最小的节点进行处理，直到所有的节点都被处理完毕。</p>
<p>算法步骤如下：</p>
<ol>
<li>
<p>给定一个加权连通图G和起点s，初始化图中各点距离数组dist， 以及visited数组，表示该点是否被访问过。</p>
</li>
<li>
<p>将起点s加入到visited数组中，并将起点到每个相邻点的距离存储在dist数组中。</p>
</li>
<li>
<p>在加入起点s后，遍历它的所有相邻点，更新它们的距离值（如果距离比之前算出的更小）。</p>
</li>
<li>
<p>从尚未处理的节点中选取距离值最小的节点进行处理，将它加入到visited数组中。</p>
</li>
<li>
<p>重复以上步骤，直到所有点都被扫描为止。</p>
</li>
</ol>
<p>下面是使用Python实现Dijkstra算法的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> heapq</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">dijkstra</span><span style="color: #C9D1D9">(graph, start):</span></span>
<span class="line"><span style="color: #C9D1D9">    visited </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">set</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    distances </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {start: </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #C9D1D9">    pq </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, start)]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> pq:</span></span>
<span class="line"><span style="color: #C9D1D9">        (dist, cur) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> heapq.heappop(pq)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> cur </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> visited:</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">continue</span></span>
<span class="line"><span style="color: #C9D1D9">        visited.add(cur)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> neighbor, weight </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> graph[cur].items():</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> neighbor </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> visited:</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">continue</span></span>
<span class="line"><span style="color: #C9D1D9">            next_distance </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> dist </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> weight</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> neighbor </span><span style="color: #FF7B72">not</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> distances </span><span style="color: #FF7B72">or</span><span style="color: #C9D1D9"> next_distance </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> distances[neighbor]:</span></span>
<span class="line"><span style="color: #C9D1D9">                distances[neighbor] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> next_distance</span></span>
<span class="line"><span style="color: #C9D1D9">                heapq.heappush(pq, (next_distance, neighbor))</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> distances</span></span></code></pre>
<p>以上代码中，我们使用优先队列（以堆的形式来实现）来维护每个节点距离起点的最小距离值，同时使用visited集合来记录已经访问过的节点；不断地从优先队列中选取距离起点最近的节点进行处理，分析它的相邻节点，将它们的距离更新为更小的值。注意，网络的边权可以存储在字典中，也可以使用邻接矩阵的方式进行存储。</p>
<p>最后，我们可以调用dijkstra函数，传入一张加权有向图和起点，即可得到起点到每个节点的最短路径距离。</p>
<p>下面是一个示例图的代码实现：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">graph </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">'A'</span><span style="color: #C9D1D9">: {</span><span style="color: #A5D6FF">'B'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'D'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">'B'</span><span style="color: #C9D1D9">: {</span><span style="color: #A5D6FF">'C'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'D'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">'C'</span><span style="color: #C9D1D9">: {</span><span style="color: #A5D6FF">'D'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">'D'</span><span style="color: #C9D1D9">: {}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">distances </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> dijkstra(graph, </span><span style="color: #A5D6FF">'A'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(distances)</span></span>
<span class="line"><span style="color: #8B949E"># Output: {'A': 0, 'D': 2, 'B': 3, 'C': 4}</span></span></code></pre>
<p>以上代码输出的distances字典表示起点’A’到其他节点的最短路径距离。</p>
<h2 id="user-16">user:</h2>
<p>go语言提取pdf文件的内容</p>
<h2 id="assistant-16">assistant:</h2>
<p>要提取PDF文件的内容，首先需要将PDF文件解析成文本格式。在Go语言中，可以使用第三方包”github.com/adrg/xdg-utils/pdf”提取PDF文件的文本内容。</p>
<p>以下是使用Go语言提取PDF文件内容的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">bufio</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">os</span><span style="color: #A5D6FF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">github.com/adrg/xdg-utils/pdf</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 打开PDF文件</span></span>
<span class="line"><span style="color: #C9D1D9">    f, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> os.</span><span style="color: #79C0FF">Open</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"example.pdf"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">panic</span><span style="color: #C9D1D9">(err)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">defer</span><span style="color: #C9D1D9"> f.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 解析PDF文件，并提取文本内容</span></span>
<span class="line"><span style="color: #C9D1D9">    r, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> pdf.</span><span style="color: #79C0FF">NewReader</span><span style="color: #C9D1D9">(f)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">panic</span><span style="color: #C9D1D9">(err)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    text, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> r.</span><span style="color: #79C0FF">Text</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">panic</span><span style="color: #C9D1D9">(err)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 打印PDF文件内容</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(text)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 将提取的内容保存到文本文件</span></span>
<span class="line"><span style="color: #C9D1D9">    outFile, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> os.</span><span style="color: #79C0FF">Create</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"out.txt"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">panic</span><span style="color: #C9D1D9">(err)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">defer</span><span style="color: #C9D1D9"> outFile.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    w </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> bufio.</span><span style="color: #79C0FF">NewWriter</span><span style="color: #C9D1D9">(outFile)</span></span>
<span class="line"><span style="color: #C9D1D9">    w.</span><span style="color: #79C0FF">WriteString</span><span style="color: #C9D1D9">(text)</span></span>
<span class="line"><span style="color: #C9D1D9">    w.</span><span style="color: #79C0FF">Flush</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在以上代码中，我们首先使用os.Open()函数打开PDF文件，然后使用pdf.NewReader()函数解析PDF文件。接着，使用r.Text()函数提取PDF文件的文本内容，并将它保存到text变量中。最后，我们将提取的文本内容打印到屏幕上，并将其保存到文本文件中。</p>
<p>如果需要提取PDF文件的其他内容，例如图片或表格等，可以使用其他的PDF解析库或软件，例如open-source PDFlib等。</p>
<h2 id="user-17">user:</h2>
<p>zig实现一个windows服务</p>
<h2 id="assistant-17">assistant:</h2>
<p>Zig语言可以通过系统调用来实现Windows服务。具体而言，可以使用WinAPI中的两个函数CreateService和StartService来创建和启动Windows服务。</p>
<p>以下是实现Windows服务的基本步骤：</p>
<ol>
<li>创建Windows服务</li>
</ol>
<p>首先，我们需要调用WinAPI中的CreateService函数来创建一个Windows服务。该函数需要指定服务名、服务显示名称、服务权限、服务类型、服务启动类型、服务错误控制等信息。通常情况下，服务权限和服务类型可选择使用缺省值。而服务的启动类型、错误控制与执行程序路径等信息则需要根据具体的项目需要来指定。创建服务的代码如下所示：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">const winapi = @import("std").win32;</span></span>
<span class="line"><span style="color: #c9d1d9">const kernel32 = winapi.kernel32;</span></span>
<span class="line"><span style="color: #c9d1d9">const advapi32 = winapi.advapi32;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn createService(name: []const u8, displayName: []const u8, path: []const u8) !u32 {</span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceManager = try advapi32.OpenSCManagerW(null, null, winapi.SC_MANAGER_ALL_ACCESS);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceManager);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceHandle = try advapi32.CreateServiceW(serviceManager, name, displayName,</span></span>
<span class="line"><span style="color: #c9d1d9">        winapi.SERVICE_ALL_ACCESS, winapi.SERVICE_WIN32_OWN_PROCESS, winapi.SERVICE_AUTO_START,</span></span>
<span class="line"><span style="color: #c9d1d9">        winapi.SERVICE_ERROR_NORMAL, path, null, null, null, null, null);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceHandle);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var status = advapi32.StartServiceW(serviceHandle, 0, null);</span></span>
<span class="line"><span style="color: #c9d1d9">    switch (status) {</span></span>
<span class="line"><span style="color: #c9d1d9">        .error => return status.errorCode,</span></span>
<span class="line"><span style="color: #c9d1d9">        else => return 0,</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span></code></pre>
<ol start="2">
<li>启动Windows服务</li>
</ol>
<p>创建服务之后，需要调用WinAPI中的StartService函数来启动该服务。该函数需要指定服务句柄，控制参数和服务接收器结构体等信息。启动服务的代码如下所示：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">const winapi = @import("std").win32;</span></span>
<span class="line"><span style="color: #c9d1d9">const advapi32 = winapi.advapi32;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn startService(name: []const u8) !u32 {</span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceManager = try advapi32.OpenSCManagerW(null, null, winapi.SC_MANAGER_ALL_ACCESS);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceManager);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceHandle = try advapi32.OpenServiceW(serviceManager, name,</span></span>
<span class="line"><span style="color: #c9d1d9">        winapi.SERVICE_ALL_ACCESS);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceHandle);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var status = advapi32.StartServiceW(serviceHandle, 0, null);</span></span>
<span class="line"><span style="color: #c9d1d9">    switch (status) {</span></span>
<span class="line"><span style="color: #c9d1d9">        .error => return status.errorCode,</span></span>
<span class="line"><span style="color: #c9d1d9">        else => return 0,</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span></code></pre>
<p>最后，将创建服务和启动服务的代码整合起来，即可实现一个简单的Windows服务。完整代码如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">const winapi = @import("std").win32;</span></span>
<span class="line"><span style="color: #c9d1d9">const kernel32 = winapi.kernel32;</span></span>
<span class="line"><span style="color: #c9d1d9">const advapi32 = winapi.advapi32;</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn createService(name: []const u8, displayName: []const u8, path: []const u8) !u32 {</span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceManager = try advapi32.OpenSCManagerW(null, null, winapi.SC_MANAGER_ALL_ACCESS);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceManager);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceHandle = try advapi32.CreateServiceW(serviceManager, name, displayName,</span></span>
<span class="line"><span style="color: #c9d1d9">        winapi.SERVICE_ALL_ACCESS, winapi.SERVICE_WIN32_OWN_PROCESS, winapi.SERVICE_AUTO_START,</span></span>
<span class="line"><span style="color: #c9d1d9">        winapi.SERVICE_ERROR_NORMAL, path, null, null, null, null, null);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceHandle);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var status = advapi32.StartServiceW(serviceHandle, 0, null);</span></span>
<span class="line"><span style="color: #c9d1d9">    switch (status) {</span></span>
<span class="line"><span style="color: #c9d1d9">        .error => return status.errorCode,</span></span>
<span class="line"><span style="color: #c9d1d9">        else => return 0,</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">pub fn startService(name: []const u8) !u32 {</span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceManager = try advapi32.OpenSCManagerW(null, null, winapi.SC_MANAGER_ALL_ACCESS);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceManager);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var serviceHandle = try advapi32.OpenServiceW(serviceManager, name,</span></span>
<span class="line"><span style="color: #c9d1d9">        winapi.SERVICE_ALL_ACCESS);</span></span>
<span class="line"><span style="color: #c9d1d9">    defer _ = try kernel32.CloseHandle(serviceHandle);</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    var status = advapi32.StartServiceW(serviceHandle, 0, null);</span></span>
<span class="line"><span style="color: #c9d1d9">    switch (status) {</span></span>
<span class="line"><span style="color: #c9d1d9">        .error => return status.errorCode,</span></span>
<span class="line"><span style="color: #c9d1d9">        else => return 0,</span></span>
<span class="line"><span style="color: #c9d1d9">    }</span></span>
<span class="line"><span style="color: #c9d1d9">}</span></span></code></pre>
<p>注意：在实现Windows服务时，还需要创建一个入口函数，并通过WinAPI中的SetServiceStatus函数实现Windows服务状态的改变，例如服务运行、暂停、继续等。这部分实现涉及较多的Windows API调用，无法在此一一列举，具体实现细节可以参考微软官方文档。</p>
<h2 id="user-18">user:</h2>
<p>go语言实现一个windows服务</p>
<h2 id="assistant-18">assistant:</h2>
<p>要在Go语言中实现Windows服务，需要借助第三方库<code>Windows服务</code>（windows/svc）的支持。下面是实现一个简单的Windows服务的基本步骤：</p>
<ol>
<li>定义Windows服务程序</li>
</ol>
<p>在Go语言中，Windows服务需要实现几个必需的函数，包括SvcStart、SvcStop、SvcShutdown、SvcPause和SvcContinue。其中，SvcStart函数实现服务的启动，SvcStop函数实现服务的停止，SvcShutdown函数实现服务的关闭，SvcPause函数实现服务的暂停，SvcContinue函数实现暂停的恢复。示例如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">time</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">golang.org/x/sys/windows/svc</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> svcName </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"MyService"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">myService</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> (m </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">myService) </span><span style="color: #D2A8FF">Execute</span><span style="color: #C9D1D9">(args []</span><span style="color: #FF7B72">string</span><span style="color: #C9D1D9">, r </span><span style="color: #FF7B72">&#x3C;-chan</span><span style="color: #C9D1D9"> svc.ChangeRequest, changes </span><span style="color: #FF7B72">chan&#x3C;-</span><span style="color: #C9D1D9"> svc.Status) (</span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">uint32</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    changes </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> svc.Status{State: svc.StartPending}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">go</span><span style="color: #C9D1D9"> m.</span><span style="color: #79C0FF">run</span><span style="color: #C9D1D9">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    changes </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> svc.Status{State: svc.Running, Accepts: svc.AcceptStop </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> svc.AcceptShutdown </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> svc.AcceptPauseAndContinue}</span></span>
<span class="line"><span style="color: #C9D1D9">    loop:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">select</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9">time.</span><span style="color: #79C0FF">After</span><span style="color: #C9D1D9">(time.Second):</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> c </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> r:</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">switch</span><span style="color: #C9D1D9"> c.Cmd {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> svc.Stop, svc.Shutdown:</span></span>
<span class="line"><span style="color: #C9D1D9">                    changes </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> svc.Status{State: svc.StopPending}</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9"> loop</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> svc.Pause:</span></span>
<span class="line"><span style="color: #C9D1D9">                    changes </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> svc.Status{State: svc.Paused, Accepts: svc.AcceptStop </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> svc.AcceptShutdown </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> svc.AcceptPauseAndContinue}</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> svc.Continue:</span></span>
<span class="line"><span style="color: #C9D1D9">                    changes </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> svc.Status{State: svc.Running, Accepts: svc.AcceptStop </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> svc.AcceptShutdown </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> svc.AcceptPauseAndContinue}</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    m.</span><span style="color: #79C0FF">stop</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    changes </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> svc.Status{State: svc.Stopped}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> (m </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">myService) </span><span style="color: #D2A8FF">run</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// service code goes here</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> (m </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">myService) </span><span style="color: #D2A8FF">stop</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// service stop code goes here</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> svc.</span><span style="color: #79C0FF">Run</span><span style="color: #C9D1D9">(svcName, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">myService{})</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">panic</span><span style="color: #C9D1D9">(err)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在以上代码中，我们定义了一个名为<code>myService</code>的结构体，实现了Execute函数。该函数包括服务启动、停止、关闭、暂停和恢复等多种状态。在启动服务时，我们首先将服务状态设置为svc.StartPending，然后通过m.run()函数来启动服务。接着，我们将服务状态设置为svc.Running，并将其接收的状态值设置为svc.AcceptStop、svc.AcceptShutdown和svc.AcceptPauseAndContinue。在服务运行过程中，我们通过select语句监听服务的状态变化，例如停止、关闭、暂停和恢复等状态。在收到这些状态变化的请求时，我们需要相应地改变服务状态，例如将状态设置为svc.Paused表示服务被暂停。最后，我们通过m.stop()函数来停止服务，并将服务状态设置为svc.Stopped。</p>
<ol start="2">
<li>安装Windows服务</li>
</ol>
<p>在Go语言中，我们可以使用“sc.exe”命令将程序安装为Windows服务。命令格式如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">sc.exe create [service name] binPath= [executable path] start= [start type]</span></span></code></pre>
<p>具体而言，我们需要通过命令行窗口进入程序所在的目录，并执行以下命令：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">sc.exe create MyService binPath= [executable path] start= auto</span></span></code></pre>
<p>以上命令中，“MyService”为服务名，“[executable path]”为程序的可执行文件路径，“start”参数为服务的启动类型，常见的启动类型包括automatic（自动启动）, manual（手动启动）和 disabled（禁用）等。</p>
<ol start="3">
<li>启动Windows服务</li>
</ol>
<p>完成安装后，我们可以通过以下命令启动Windows服务：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">sc.exe start MyService</span></span></code></pre>
<p>这会启动MyService服务，并将服务状态设置为svc.Running。</p>
<p>至此，我们就成功地实现了一个简单的Windows服务。需要注意的是，在Windows服务中，我们不能使用fmt.Println()等打印函数来输出信息，而需要使用logger等专门的工具来管理服务的日志信息。</p>
<h2 id="user-19">user:</h2>
<p>C语言实现一个监控键盘输入的windows服务</p>
<h2 id="assistant-19">assistant:</h2>
<p>要在C语言中实现一个监控键盘输入的Windows服务，需要借助WinAPI中的相关函数。下面是实现过程的基本步骤：</p>
<ol>
<li>创建Windows服务</li>
</ol>
<p>在C语言中，我们需要先创建Windows服务。创建服务需要调用WinAPI中的CreateService函数。该函数需要指定服务名、服务显示名称、服务权限、服务类型、服务启动类型、服务错误控制等信息。示例代码如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">SC_HANDLE schSCManager;</span></span>
<span class="line"><span style="color: #C9D1D9">SC_HANDLE schService;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">schSCManager </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">OpenSCManager</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, SC_MANAGER_ALL_ACCESS);</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (schSCManager </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Failed to open service manager (</span><span style="color: #79C0FF">%d</span><span style="color: #A5D6FF">)"</span><span style="color: #C9D1D9">, </span><span style="color: #D2A8FF">GetLastError</span><span style="color: #C9D1D9">());</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">CloseServiceHandle</span><span style="color: #C9D1D9">(schSCManager);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">schService </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">CreateService</span><span style="color: #C9D1D9">(schSCManager, </span><span style="color: #A5D6FF">"MyService"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"My Windows Service"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">               SERVICE_ALL_ACCESS, SERVICE_WIN32_OWN_PROCESS,</span></span>
<span class="line"><span style="color: #C9D1D9">               SERVICE_AUTO_START, SERVICE_ERROR_NORMAL,</span></span>
<span class="line"><span style="color: #C9D1D9">               </span><span style="color: #A5D6FF">"C:</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">path</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">to</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">my</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">program.exe"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">               </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (schService </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Failed to create service (</span><span style="color: #79C0FF">%d</span><span style="color: #A5D6FF">)"</span><span style="color: #C9D1D9">, </span><span style="color: #D2A8FF">GetLastError</span><span style="color: #C9D1D9">());</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">CloseServiceHandle</span><span style="color: #C9D1D9">(schSCManager);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">CloseServiceHandle</span><span style="color: #C9D1D9">(schService);</span></span>
<span class="line"><span style="color: #D2A8FF">CloseServiceHandle</span><span style="color: #C9D1D9">(schSCManager);</span></span></code></pre>
<p>以上代码中，我们首先调用OpenSCManager函数打开服务管理器，并设置访问权限。接着，我们调用CreateService函数创建Windows服务，并指定服务名、服务显示名称、执行程序路径、服务类型等信息。</p>
<ol start="2">
<li>监控键盘输入</li>
</ol>
<p>创建Windows服务之后，我们需要在服务中监控键盘输入。在C语言中，我们可以调用WinAPI中的GetAsyncKeyState函数来获取键盘的输入状态。例如，我们可以使用以下代码来检测用户是否按下了“ESC”键：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">GetAsyncKeyState</span><span style="color: #C9D1D9">(VK_ESCAPE) </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">0x</span><span style="color: #79C0FF">8000</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// user pressed ESC key</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在以上代码中，我们使用while循环来持续监听键盘输入。当用户按下“ESC”键时，GetAsyncKeyState函数将返回值的第15位（0x8000）设置为1，表示键正在按下。我们可以通过按位与操作来检测这个返回值。</p>
<ol start="3">
<li>实现Windows服务入口函数</li>
</ol>
<p>最后，需要在C语言程序中实现Windows服务的入口函数。在Windows服务中，入口函数为“ServiceMain”。可以通过以下代码注册服务入口函数：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> WINAPI </span><span style="color: #D2A8FF">ServiceMain</span><span style="color: #C9D1D9">(DWORD </span><span style="color: #FFA657">argc</span><span style="color: #C9D1D9">, LPTSTR </span><span style="color: #FF7B72">*</span><span style="color: #FFA657">argv</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// your service code goes here</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">_tmain</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">argc</span><span style="color: #C9D1D9">, _TCHAR</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">argv</span><span style="color: #FF7B72">[]</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    SERVICE_TABLE_ENTRY ServiceTable</span><span style="color: #FF7B72">[]</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        { </span><span style="color: #D2A8FF">TEXT</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"MyServiceName"</span><span style="color: #C9D1D9">), (LPSERVICE_MAIN_FUNCTION) ServiceMain },</span></span>
<span class="line"><span style="color: #C9D1D9">        { </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"><span style="color: #C9D1D9">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">StartServiceCtrlDispatcher</span><span style="color: #C9D1D9">(ServiceTable) </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">FALSE</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">GetLastError</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>以上代码中，我们定义了一个SERVICE_TABLE_ENTRY结构体数组，并通过StartServiceCtrlDispatcher函数将服务入口函数SERVICE_MAIN_FUNCTION（题目要求监控键盘输入，其ServiceMain函数需要在这里实现）注册到服务控制管理器中。一旦注册成功，服务将开始运行起来。</p>
<p>至此，我们就成功地实现了一个监控键盘输入的Windows服务。需要注意的是，在Windows服务中，我们不能使用printf等标准输出函数，而需要使用特定的日志管理工具来输出服务信息及错误信息。</p>
<h2 id="user-20">user:</h2>
<p>Rust实现一个监控键盘输入的Linux模块</p>
<h2 id="assistant-20">assistant:</h2>
<p>要在Rust中实现一个监控键盘输入的Linux模块，需要使用系统的ioctl接口来获取输入事件。下面是实现过程的基本步骤：</p>
<ol>
<li>安装Rust</li>
</ol>
<p>首先，需要将Rust安装到本地环境中。访问<a href="https://www.rust-lang.org/%E4%B8%8B%E8%BD%BDrustup%E3%80%82%E6%8E%A8%E8%8D%90%E9%80%89%E6%8B%A9%E9%BB%98%E8%AE%A4%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E3%80%82">https://www.rust-lang.org/下载rustup。推荐选择默认安装方式。</a></p>
<ol start="2">
<li>创建Linux模块</li>
</ol>
<p>使用Rust语言编写的Linux模块需要使用 cargo 开发包来管理。在创建 Rust Linux 模块之前，我们需要先安装kernel-devel或linux-headers。执行以下命令来安装：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">$ sudo apt install kernel-devel</span></span></code></pre>
<p>在安装完成后，我们可以通过以下命令来创建一个新的 Rust Linux 模块：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">$ cargo new --bin my_linux_module</span></span></code></pre>
<p>以上命令将创建一个名为 my_linux_module 的新项目。在此项目中，我们将实现Linux模块的键盘输入事件监控功能。</p>
<ol start="3">
<li>实现Linux模块</li>
</ol>
<p>在 my_linux_module/src/main.rs 文件中，我们可以实现Linux模块的功能。首先，我们需要导入一些必要的包：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">fs</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">File</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">OpenOptions</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">BufRead</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">BufReader</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">os</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">unix</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">AsRawFd</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">RawFd</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">os</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">raw</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">c_int;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{ioctl, fd_set, timeval};</span></span></code></pre>
<p>接着，我们需要定义一些常量和结构体，用于 ioctl 函数的调用：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">EV_KEY</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">u16</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0x01</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">KEYBOARD_FILE</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">str</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"/dev/input/event0"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BUF_SIZE</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">24</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">#[repr(</span><span style="color: #FFA657">C</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> input_event {</span></span>
<span class="line"><span style="color: #C9D1D9">    time</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> timeval,</span></span>
<span class="line"><span style="color: #C9D1D9">    type_</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">u16</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    code</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">u16</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    value</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> c_int,</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">fd_to_rawfd</span><span style="color: #C9D1D9">(file</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">File</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">RawFd</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    file</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">as_raw_fd</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>以上代码定义了枚举类型 EV_KEY，用于标识输入事件类型；定义了键盘输入文件（假定为 /dev/input/event0）常量 KEYBOARD_FILE；定义了输入事件结构体 input_event，包括时间、类型、键码和键值等信息；还定义了一个将 Rust 文件转换为原生文件描述符的辅助函数 fd_to_rawfd。</p>
<p>在实现 Linux 模块之前，我们需要打开键盘输入文件，以便读取输入事件。在 Linux 中，可以使用 File 类型来操作文件。我们可以使用以下代码来打开键盘输入文件：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> file </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">OpenOptions</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">open</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">KEYBOARD_FILE</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> fd </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">fd_to_rawfd</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">file);</span></span></code></pre>
<p>OpenOptions 的 read 方法用于打开文件的只读模式。接着，我们将 File 对象转换为一个原生文件描述符，并将该描述符 fd 传入 ioctl 函数中，来获取输入事件。</p>
<p>在获取输入事件之前，我们需要设置 select 函数的时间超时和监听的读变化事件。用户通过键盘输入时，/Linux 内核将不断为键盘输入设备生成输入事件。我们可以使用 select 函数来监听读事件，读取输入事件并处理。以下代码说明如何设置 fd_set（文件描述符集合）和 timeval（时间参数）：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> set </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">fd_set</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">default</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">BUF_SIZE</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> ts </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> timeval { tv_sec</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, tv_usec</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">loop</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">FD_ZERO</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> set);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">FD_SET</span><span style="color: #C9D1D9">(fd, </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> set);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> ret </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">unsafe</span><span style="color: #C9D1D9"> { </span><span style="color: #FFA657">libc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">select</span><span style="color: #C9D1D9">(fd </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> set </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*mut</span><span style="color: #C9D1D9"> fd_set,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ptr</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">null_mut</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ptr</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">null_mut</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> ts) };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ret </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">eprintln!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"select error"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ret </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> reader </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">BufReader</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">file);</span></span>
<span class="line"><span style="color: #C9D1D9">        reader</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> buf[</span><span style="color: #FF7B72">..</span><span style="color: #C9D1D9">])</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> event</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> input_event </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">unsafe</span><span style="color: #C9D1D9"> { </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">mem</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">transmute</span><span style="color: #C9D1D9">(buf) };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> event</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">type_ </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">EV_KEY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> event</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">value </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"event received: {:?}"</span><span style="color: #C9D1D9">, event);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在以上代码中，我们首先定义一个 BUF_SIZE 大小的 buf 数组，用于读取输入事件。在 while 循环中，我们使用 FD_ZERO、FD_SET 和 select 函数来监听读事件。参数 set 表示文件描述符集合，将监听的文件描述符 add 到 set 中。tv_sec 设置超时秒数，默认为 1 秒。</p>
<p>select 函数返回时，我们读取输入事件并打印信息。如果输入事件的 type_ 等于 EV_KEY，表示该事件是按键事件，并且 value 等于 1，表示按键被按下。我们可以使用 println 对输入事件进行打印。此时，我们就成功地在 Linux 服务器中实现了一个键盘输入事件监控模块。</p>
<ol start="4">
<li>编译并运行Linux模块</li>
</ol>
<p>在上述代码完成后，我们可以通过以下方式编译和运行Linux模块：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">$ cargo build --release</span></span>
<span class="line"><span style="color: #c9d1d9">$ insmod ./target/release/my_linux_module</span></span></code></pre>
<p>这将将Linux模块加载到Linux内核中，使其可以监听键盘输入事件中的按键事件。</p>
<h2 id="user-21">user:</h2>
<p>Rust编写Python扩展</p>
<h2 id="assistant-21">assistant:</h2>
<p>Rust可以轻松与Python集成，而Python的扩展模块是最常用的集成方式之一。在本文中，我们将介绍如何使用Rust编写Python扩展模块。</p>
<ol>
<li>安装rust-cpython</li>
</ol>
<p>要编写Python扩展，需要安装一个名为rust-cpython的Rust包。这个包通过提供Rust版本的Python C API，使得Rust与Python更容易地进行交互。我们可以使用Rust的包管理器 cargo 来安装：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">$ cargo install cpython</span></span></code></pre>
<p>安装完毕后，就可以在我们的代码中使用 rust-cpython 包来开发Python扩展。</p>
<ol start="2">
<li>Rust代码示例</li>
</ol>
<p>下面我们将介绍一个基本的Rust代码示例，用于将Python列表中的每个元素乘以2。代码示例：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">extern</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">crate</span><span style="color: #C9D1D9"> cpython;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">cpython</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">PyResult</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Python</span><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">double_list</span><span style="color: #C9D1D9">(py</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Python</span><span style="color: #C9D1D9">, list</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">>) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PyResult</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">>> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> result</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> list</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">x</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> x)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">collect</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(result)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> gil </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Python</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">acquire_gil</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> py </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> gil</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">python</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">py_fn!</span><span style="color: #C9D1D9">(py, </span><span style="color: #D2A8FF">double_list</span><span style="color: #C9D1D9">(list</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">>));</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在上述代码中，我们首先通过 “extern crate cpython” 导入 cpython 包。接着，我们定义一个 double_list 函数来完成列表元素的乘以 2，并在最后使用 py_fn! 宏将此函数导入Python模块中。</p>
<ol start="3">
<li>导出Python模块</li>
</ol>
<p>接下来，我们需要将Rust代码打包成Python模块，并导出到Python环境中。为此，我们需要编写一个名为 lib.rs 的主模块，并在其中添加一些PyModule实例来导出Rust函数。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">#[macro_use]</span></span>
<span class="line"><span style="color: #FF7B72">extern</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">crate</span><span style="color: #C9D1D9"> cpython;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">cpython</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">PyResult</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Python</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">PyModule</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">PyList</span><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">double_list</span><span style="color: #C9D1D9">(py</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Python</span><span style="color: #C9D1D9">, list</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;</span><span style="color: #FFA657">PyList</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PyResult</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">PyList</span><span style="color: #C9D1D9">> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> result</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&#x3C;</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> list</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">(py)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">x</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> x</span><span style="color: #FF7B72">?.</span><span style="color: #D2A8FF">extract</span><span style="color: #C9D1D9">(py)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">collect</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> py_result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PyList</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(py, </span><span style="color: #FF7B72">&#x26;</span><span style="color: #C9D1D9">result)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_object</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(py_result)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">py_module_initializer!</span><span style="color: #C9D1D9">(_my_module, init_my_module, PyInit_my_module, </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">py, m</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    m</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add</span><span style="color: #C9D1D9">(py, </span><span style="color: #A5D6FF">"__doc__"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"This module is implemented in Rust"</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    m</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add</span><span style="color: #C9D1D9">(py, </span><span style="color: #A5D6FF">"double_list"</span><span style="color: #C9D1D9">, </span><span style="color: #D2A8FF">py_fn!</span><span style="color: #C9D1D9">(py, </span><span style="color: #D2A8FF">double_list</span><span style="color: #C9D1D9">(list</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PyList</span><span style="color: #C9D1D9">)))</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(())</span></span>
<span class="line"><span style="color: #C9D1D9">});</span></span></code></pre>
<p>在以上代码中，我们首先引入 cpython 包。接着，我们实现了 double_list 函数，其中参数 list 是 PyList 类型的列表。该函数将计算每个元素的二倍值，并将其存储在一个新的 PyList 中，然后返回该 PyList。在最后，我们使用 py_module_initializer! 宏将 Rust 函数打包成一个名为 “my_module” 的 Python 模块。</p>
<ol start="4">
<li>编译扩展模块</li>
</ol>
<p>现在，我们可以将 Rust 代码编译成扩展模块。我们将使用 Rust 的包管理器 cargo 和 Python 的 distutils 包来执行这个任务。</p>
<p>首先，我们需要创建一个名为 setup.py 的 Python 脚本，用于构建和安装扩展模块：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> setuptools </span><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> setup, Extension</span></span>
<span class="line"><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> distutils.dir_util </span><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> copy_tree</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> subprocess</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">subprocess.call(</span><span style="color: #A5D6FF">'cargo build --release'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">shell</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">copy_tree(</span><span style="color: #A5D6FF">'target/release/'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'.'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">setup(</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'my_module'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">version</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'1.0'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">description</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'My Python module written in Rust'</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">ext_modules</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[Extension(</span><span style="color: #A5D6FF">'my_module'</span><span style="color: #C9D1D9">, [</span><span style="color: #A5D6FF">'src/lib.rs'</span><span style="color: #C9D1D9">])],</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span></code></pre>
<p>在上述代码中，我们首先使用 “subprocess” 库调用 “cargo build” 命令来编译 Rust 代码。接着，我们使用 “copy_tree” 函数根据 “target/release/” 中的代码来构建 “src/” 目录下的 Python 扩展模块代码。最后，我们使用 “Extension” 函数来创建扩展模块对象。</p>
<p>完成 setup.py 脚本后，我们可以通过以下命令安装扩展模块：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">$ python setup.py install</span></span></code></pre>
<p>安装完成后，就可以在 Python 中导入并使用我们的 Rust 函数了：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> my_module</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">lst </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">5</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(my_module.double_list(lst))</span></span></code></pre>
<p>上述代码将输出一个新的 Python 列表 [2, 4, 6, 8, 10]，其中的每个元素都是原始列表中对应元素的两倍。</p>
<p>恭喜，你已经成功地使用 Rust 编写了一个Python扩展模块！</p>
<h2 id="user-22">user:</h2>
<p>C语言实现俄罗斯方块</p>
<h2 id="assistant-22">assistant:</h2>
<p>以下是一个简单的 C 语言实现俄罗斯方块的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;stdio.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;stdlib.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;conio.h></span></span>
<span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#x3C;time.h></span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">#define</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span></span>
<span class="line"><span style="color: #FF7B72">#define</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">20</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[BOARD_HEIGHT][BOARD_WIDTH] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}},</span><span style="color: #8B949E"> // I</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}},</span><span style="color: #8B949E"> // T</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}},</span><span style="color: #8B949E"> // O</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}},</span><span style="color: #8B949E"> // S</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}},</span><span style="color: #8B949E"> // Z</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}},</span><span style="color: #8B949E"> // L</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}}</span><span style="color: #8B949E">  // J</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> current_shape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">init_board</span><span style="color: #C9D1D9">(){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_HEIGHT; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_WIDTH; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> BOARD_HEIGHT </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(j </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> BOARD_WIDTH </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">clear_board</span><span style="color: #C9D1D9">(){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_HEIGHT; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_WIDTH; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">draw_board</span><span style="color: #C9D1D9">(){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_HEIGHT; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_WIDTH; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[i][j] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"#"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[i][j] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"*"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">else</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">" "</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">printf</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\n</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">collision</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shape</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">pos</span><span style="color: #FF7B72">[]</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> BOARD_HEIGHT </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> BOARD_WIDTH </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[y][x] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">rotate_shape</span><span style="color: #C9D1D9">(){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">new_shape</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">new_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">new_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">old_shape</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">old_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">old_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">new_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">new_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">collision</span><span style="color: #C9D1D9">(current_shape, current_pos)){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">old_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">old_shape</span><span style="color: #C9D1D9">[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">add_shape</span><span style="color: #C9D1D9">(){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_HEIGHT </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_WIDTH)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[y][x] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">remove_shape</span><span style="color: #C9D1D9">(){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">shapes</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_HEIGHT </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> BOARD_WIDTH)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">board</span><span style="color: #C9D1D9">[y][x] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">void</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">dx</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">dy</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">remove_shape</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> dy;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> dx;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">collision</span><span style="color: #C9D1D9">(current_shape, current_pos)){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">-=</span><span style="color: #C9D1D9"> dy;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">-=</span><span style="color: #C9D1D9"> dx;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">add_shape</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> BOARD_WIDTH </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        current_shape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">rand</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">%</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">add_shape</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">(){</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9"> ch;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">srand</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">time</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">NULL</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">init_board</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">current_pos</span><span style="color: #C9D1D9">[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> BOARD_WIDTH </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    current_shape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">rand</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">%</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">){</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">kbhit</span><span style="color: #C9D1D9">()){</span></span>
<span class="line"><span style="color: #C9D1D9">            ch </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">getch</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'q'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'a'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'d'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'s'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'w'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">rotate_shape</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">clear_board</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">draw_board</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">Sleep</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">200</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">system</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"cls"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在上述代码中，我们使用了 Windows 平台的 conio.h 库和 Sleep 函数，如果你需要在其他平台上运行，请使用相应的库和函数。</p>
<p>启动程序后，可以使用 a、d、s 和 w 键来控制方块的移动和旋转。程序可以在控制台中玩俄罗斯方块游戏。</p>
<h2 id="user-23">user:</h2>
<p>go</p>
<h2 id="assistant-23">assistant:</h2>
<p>Go（又称 Golang）是谷歌公司开发的一种新型编程语言，被称为“互联网时代的 C 语言”，它的设计目标是提供一种简单、高效、安全、并行的编程语言。</p>
<p>以下是一个简单的 Go 代码示例，用于输出“Hello, World!”：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    fmt.</span><span style="color: #79C0FF">Println</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Hello, World!"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在上述代码中，我们首先使用 “package main” 定义了一个名为 “main” 的程序包。接着，我们使用 “import” 关键字导入了一个名为 “fmt” 的标准库，该库提供了帮助进行格式化输入输出的功能。最后，我们在 “main” 函数中使用 “fmt.Println” 函数打印了一条消息。</p>
<p>Go 的语法类似于 C 语言，但相比于 C 语言更简洁，代码的可读性更强。Go 还支持并发编程，这使得它在构建高性能网络应用和服务器等方面非常有用。</p>
<h2 id="user-24">user:</h2>
<p>实现一个俄罗斯方块</p>
<h2 id="assistant-24">assistant:</h2>
<p>以下是一个使用 Go 语言实现俄罗斯方块的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">package</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">fmt</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">math/rand</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">time</span><span style="color: #A5D6FF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">term</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"</span><span style="color: #FFA657">github.com/nsf/termbox-go</span><span style="color: #A5D6FF">"</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">    boardWidth  </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span></span>
<span class="line"><span style="color: #C9D1D9">    boardHeight </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">20</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> board [boardHeight][boardWidth]</span><span style="color: #FF7B72">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> shapes </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}}, </span><span style="color: #8B949E">// I</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}}, </span><span style="color: #8B949E">// T</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}}, </span><span style="color: #8B949E">// O</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}}, </span><span style="color: #8B949E">// S</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}}, </span><span style="color: #8B949E">// Z</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}}, </span><span style="color: #8B949E">// L</span></span>
<span class="line"><span style="color: #C9D1D9">    {{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}, {</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}}, </span><span style="color: #8B949E">// J</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> currentShape </span><span style="color: #FF7B72">int</span></span>
<span class="line"><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> currentPos </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">initBoard</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardHeight; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardWidth; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> boardHeight</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                board[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> boardWidth</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                board[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">clearBoard</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardHeight; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardWidth; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            board[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">drawBoard</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardHeight; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; j </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardWidth; j</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> board[i][j] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                term.</span><span style="color: #79C0FF">SetCell</span><span style="color: #C9D1D9">(j, i, </span><span style="color: #A5D6FF">'</span><span style="color: #79C0FF">#</span><span style="color: #A5D6FF">'</span><span style="color: #C9D1D9">, term.ColorDefault, term.ColorDefault)</span></span>
<span class="line"><span style="color: #C9D1D9">            } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> board[i][j] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                term.</span><span style="color: #79C0FF">SetCell</span><span style="color: #C9D1D9">(j, i, </span><span style="color: #A5D6FF">'</span><span style="color: #79C0FF">*</span><span style="color: #A5D6FF">'</span><span style="color: #C9D1D9">, term.ColorDefault, term.ColorDefault)</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    term.</span><span style="color: #79C0FF">Flush</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">collision</span><span style="color: #C9D1D9">(shape </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">, pos [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        y </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> shapes[shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        x </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> shapes[shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> boardHeight </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> boardWidth </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> board[y][x] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">rotateShape</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    newShape </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        newShape[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> shapes[currentShape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        newShape[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">shapes[currentShape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    oldShape </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">][</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">{}</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        oldShape[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> shapes[currentShape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        oldShape[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> shapes[currentShape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        shapes[currentShape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> newShape[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        shapes[currentShape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> newShape[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">collision</span><span style="color: #C9D1D9">(currentShape, currentPos) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            shapes[currentShape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> oldShape[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">            shapes[currentShape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> oldShape[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">addShape</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        y </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> currentPos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> shapes[currentShape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        x </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> currentPos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> shapes[currentShape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardHeight </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardWidth {</span></span>
<span class="line"><span style="color: #C9D1D9">            board[y][x] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">removeShape</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        y </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> currentPos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> shapes[currentShape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        x </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> currentPos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> shapes[currentShape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardHeight </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> boardWidth {</span></span>
<span class="line"><span style="color: #C9D1D9">            board[y][x] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveShape</span><span style="color: #C9D1D9">(dx, dy </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">removeShape</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    currentPos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> dy</span></span>
<span class="line"><span style="color: #C9D1D9">    currentPos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> dx</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">collision</span><span style="color: #C9D1D9">(currentShape, currentPos) {</span></span>
<span class="line"><span style="color: #C9D1D9">        currentPos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">-=</span><span style="color: #C9D1D9"> dy</span></span>
<span class="line"><span style="color: #C9D1D9">        currentPos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">-=</span><span style="color: #C9D1D9"> dx</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">addShape</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        currentPos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">        currentPos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> boardWidth</span><span style="color: #FF7B72">/</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span></span>
<span class="line"><span style="color: #C9D1D9">        currentShape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> rand.</span><span style="color: #79C0FF">Intn</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">addShape</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">runGame</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    term.</span><span style="color: #79C0FF">Init</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">defer</span><span style="color: #C9D1D9"> term.</span><span style="color: #79C0FF">Close</span><span style="color: #C9D1D9">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    rand.</span><span style="color: #79C0FF">Seed</span><span style="color: #C9D1D9">(time.</span><span style="color: #79C0FF">Now</span><span style="color: #C9D1D9">().</span><span style="color: #79C0FF">UTC</span><span style="color: #C9D1D9">().</span><span style="color: #79C0FF">UnixNano</span><span style="color: #C9D1D9">())</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">initBoard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    currentPos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> boardWidth</span><span style="color: #FF7B72">/</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span></span>
<span class="line"><span style="color: #C9D1D9">    currentShape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> rand.</span><span style="color: #79C0FF">Intn</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    evtQuit </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">chan</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">bool</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    evtMove </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">make</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">chan</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">int</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    term.</span><span style="color: #79C0FF">SetInputMode</span><span style="color: #C9D1D9">(term.InputEsc </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> term.InputMouse)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">go</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">func</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            evt </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> term.</span><span style="color: #79C0FF">PollEvent</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">switch</span><span style="color: #C9D1D9"> evt.Type {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> term.EventKey:</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">switch</span><span style="color: #C9D1D9"> evt.Key {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> term.KeyEsc:</span></span>
<span class="line"><span style="color: #C9D1D9">                    evtQuit </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> term.KeyArrowLeft:</span></span>
<span class="line"><span style="color: #C9D1D9">                    evtMove </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> term.KeyArrowRight:</span></span>
<span class="line"><span style="color: #C9D1D9">                    evtMove </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> term.KeyArrowDown:</span></span>
<span class="line"><span style="color: #C9D1D9">                    evtMove </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> term.KeySpace:</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #79C0FF">rotateShape</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    ticker </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> time.</span><span style="color: #79C0FF">NewTicker</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">200</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> time.Millisecond)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">loop:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">select</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9">evtQuit:</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9"> loop</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> dx </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9">evtMove:</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">moveShape</span><span style="color: #C9D1D9">(dx, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">case</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x3C;-</span><span style="color: #C9D1D9">ticker.C:</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">moveShape</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">clearBoard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">drawBoard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">func</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">runGame</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在上述代码中，我们使用了 termbox-go 库来实现在命令行界面绘制俄罗斯方块。启动程序后，你可以使用键盘的左、右、下和空格键来控制方块的移动和旋转。程序可以在终端中玩俄罗斯方块游戏。</p>
<h2 id="user-25">user:</h2>
<p>rust实现</p>
<h2 id="assistant-25">assistant:</h2>
<p>以下是使用 Rust 实现俄罗斯方块的示例代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">extern</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">crate</span><span style="color: #C9D1D9"> rand;</span></span>
<span class="line"><span style="color: #FF7B72">extern</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">crate</span><span style="color: #C9D1D9"> termion;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">rand</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">prelude</span><span style="color: #FF7B72">::*</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{stdout, </span><span style="color: #FFA657">Write</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{thread, time};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">termion</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">event</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Key</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">termion</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">input</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">TermRead</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">termion</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">raw</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">IntoRawMode</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">20</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> [[[</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]; </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">]; </span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span></span>
<span class="line"><span style="color: #C9D1D9">    [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]],</span><span style="color: #8B949E"> // I</span></span>
<span class="line"><span style="color: #C9D1D9">    [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]],</span><span style="color: #8B949E"> // T</span></span>
<span class="line"><span style="color: #C9D1D9">    [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]],</span><span style="color: #8B949E"> // O</span></span>
<span class="line"><span style="color: #C9D1D9">    [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]],</span><span style="color: #8B949E"> // S</span></span>
<span class="line"><span style="color: #C9D1D9">    [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]],</span><span style="color: #8B949E"> // Z</span></span>
<span class="line"><span style="color: #C9D1D9">    [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]],</span><span style="color: #8B949E"> // L</span></span>
<span class="line"><span style="color: #C9D1D9">    [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">], [</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]],</span><span style="color: #8B949E"> // J</span></span>
<span class="line"><span style="color: #C9D1D9">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Board</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    cells</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> [[</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9">]; </span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9">],</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">impl</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Board</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Board</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> cells </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9">]; </span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                    cells[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                    cells[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Board</span><span style="color: #C9D1D9"> { cells }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">clear</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">cells[i][j] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">draw</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> stdout </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">stdout</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> stdout </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> stdout</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">lock</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_raw_mode</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">write!</span><span style="color: #C9D1D9">(stdout, </span><span style="color: #A5D6FF">"{}"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">termion</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">clear</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">All</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> j </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">match</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">cells[i][j] {</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">write!</span><span style="color: #C9D1D9">(stdout, </span><span style="color: #A5D6FF">"#"</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">write!</span><span style="color: #C9D1D9">(stdout, </span><span style="color: #A5D6FF">"*"</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">                    _ </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">write!</span><span style="color: #C9D1D9">(stdout, </span><span style="color: #A5D6FF">" "</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">writeln!</span><span style="color: #C9D1D9">(stdout, </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        stdout</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">flush</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">collision</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;</span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">, shape</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">, pos</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">cells[y </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">][x </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">add_shape</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">, shape</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">, pos</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">cells[y </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">][x </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">remove_shape</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">, shape</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">, pos</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_HEIGHT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;&#x26;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">cells[y </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">][x </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">, shape</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">, pos</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">], dx</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">, dy</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">remove_shape</span><span style="color: #C9D1D9">(shape, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">pos);</span></span>
<span class="line"><span style="color: #C9D1D9">        pos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> dy;</span></span>
<span class="line"><span style="color: #C9D1D9">        pos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> dx;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">collision</span><span style="color: #C9D1D9">(shape, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">pos) {</span></span>
<span class="line"><span style="color: #C9D1D9">            pos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">-=</span><span style="color: #C9D1D9"> dy;</span></span>
<span class="line"><span style="color: #C9D1D9">            pos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">-=</span><span style="color: #C9D1D9"> dx;</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add_shape</span><span style="color: #C9D1D9">(shape, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">pos);</span></span>
<span class="line"><span style="color: #C9D1D9">            pos[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            pos[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">self</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add_shape</span><span style="color: #C9D1D9">(shape, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">pos);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> stdin </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">io</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">stdin</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> stdout </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">stdout</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_raw_mode</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> board </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Board</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> current_pos </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> rng </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">rand</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">thread_rng</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> current_shape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> rng</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">gen_range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> timer </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Instant</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">now</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">write!</span><span style="color: #C9D1D9">(stdout, </span><span style="color: #A5D6FF">"{}"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">termion</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">clear</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">All</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">draw</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> c </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> stdin</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">keys</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> ch </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">match</span><span style="color: #C9D1D9"> c</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">Key</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Char</span><span style="color: #C9D1D9">(ch) </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> ch,</span></span>
<span class="line"><span style="color: #C9D1D9">            _ </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">continue</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'q'</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'j'</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(current_shape, </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> current_pos, </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">                board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">draw</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'l'</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(current_shape, </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> current_pos, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">                board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">draw</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'k'</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(current_shape, </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> current_pos, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">                board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">draw</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> ch </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'i'</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">remove_shape</span><span style="color: #C9D1D9">(current_shape, current_pos);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> new_shape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">]; </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                new_shape[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">                new_shape[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> new_shape[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> new_shape[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">collision</span><span style="color: #C9D1D9">(current_shape, current_pos) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">new_shape[i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #79C0FF">SHAPES</span><span style="color: #C9D1D9">[current_shape][i][</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> new_shape[i][</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add_shape</span><span style="color: #C9D1D9">(current_shape, current_pos);</span></span>
<span class="line"><span style="color: #C9D1D9">            board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">draw</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> timer</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">elapsed</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">as_millis</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">>=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">200</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            timer </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Instant</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">now</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">move_shape</span><span style="color: #C9D1D9">(current_shape, </span><span style="color: #FF7B72">&#x26;mut</span><span style="color: #C9D1D9"> current_pos, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">                current_pos </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, (</span><span style="color: #79C0FF">BOARD_WIDTH</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">                current_shape </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> rng</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">gen_range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">7</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            board</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">draw</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在 Rust 中，我们使用了 termion 库来实现在命令行界面绘制俄罗斯方块。启动程序后，你可以使用键盘的 j、k、l 和 i 键来控制方块的移动和旋转。程序可以在终端中玩俄罗斯方块游戏。</p>
<h2 id="user-26">user:</h2>
<p>Rust开发PHP扩展</p>
<h2 id="assistant-26">assistant:</h2>
<p>在 Rust 中开发 PHP 扩展可以通过 <a href="https://github.com/divanshu-rawat/php-rs">php-rs</a> 库来实现。该库提供了一些宏和实用函数，使得在 Rust 中开发 PHP 扩展变得更加容易。</p>
<p>以下是使用 php-rs 开发简单的 PHP 扩展的示例：</p>
<ol>
<li>
<p>前提条件：</p>
<p>在开始前，你需要提前安装好 Rust 编译器和 PHP 开发环境。</p>
</li>
<li>
<p>创建工程：</p>
<p>创建一个新的 Rust 项目，并在 <code>Cargo.toml</code> 中添加依赖关系：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">[</span><span style="color: #FFA657">lib</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">name = </span><span style="color: #A5D6FF">"my_php_extension"</span></span>
<span class="line"><span style="color: #C9D1D9">crate-type = [</span><span style="color: #A5D6FF">"cdylib"</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">[</span><span style="color: #FFA657">dependencies</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">php = </span><span style="color: #A5D6FF">"0.2.0"</span></span></code></pre>
<p>在 <code>src/lib.rs</code> 中编写你的扩展代码：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">php</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">prelude</span><span style="color: #FF7B72">::*</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">php</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">types</span><span style="color: #FF7B72">::*</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">#[no_mangle]</span></span>
<span class="line"><span style="color: #FF7B72">pub</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extern</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"C"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">hello</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*mut</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ZendString</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> message </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">CString</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Hello, world!"</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">ZendString</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(message</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_bytes</span><span style="color: #C9D1D9">())</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">#[no_mangle]</span></span>
<span class="line"><span style="color: #FF7B72">pub</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extern</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"C"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">get_module</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">-></span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*mut</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Module</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> module </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Module</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"my_php_extension"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"0.1"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    module </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add_function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Function</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"hello"</span><span style="color: #C9D1D9">, hello));</span></span>
<span class="line"><span style="color: #C9D1D9">    module</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_raw</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在上述代码中，我们首先导入了 <code>php::prelude::*</code>，这个模块包含了 php-rs 库的一些预定义类型和宏。我们也导入了 <code>php::types::*</code>，这里的 <code>types</code> 模块包含了 PHP 7 中的标准类型。和写普通的 Rust 代码一样，我们可以在这个模块中使用常见类型，如 <code>String</code>，以及 Rust 的标准库及其他依赖库中的类型。</p>
<p>在 <code>hello</code> 函数中，我们向 PHP 返回了一个包含字符串 “Hello, world!” 的 <code>ZendString</code> 对象。在 <code>get_module</code> 函数中，我们创建了一个名为 <code>my_php_extension</code>，版本号为 <code>0.1</code> 的新模块。我们使用 <code>add_function</code> 方法向这个模块中添加了 <code>hello</code> 函数。</p>
</li>
<li>
<p>构建扩展：</p>
<p>编译并构建扩展：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">cargo build --release</span></span></code></pre>
<p>在 Cargo.toml 所在的目录下会生成 <code>target/release/libmy_php_extension.so</code> 文件。这就是我们的 PHP 扩展模块。</p>
</li>
<li>
<p>测试扩展：</p>
<p>在 PHP 中测试扩展。在 PHP 中使用以下代码加载上述扩展：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">&#x3C;?</span><span style="color: #79C0FF">php</span></span>
<span class="line"><span style="color: #79C0FF">dl</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'path/to/libmy_php_extension.so'</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">$message </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">hello</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> $message</span><span style="color: #FF7B72">-></span><span style="color: #D2A8FF">asString</span><span style="color: #C9D1D9">() </span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"</span><span style="color: #79C0FF">\n</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">;</span></span></code></pre>
<p>运行这个脚本，你应该可以看到输出 “Hello, world!”。</p>
</li>
</ol>
<h2 id="user-27">user:</h2>
<p>C++实现PHP扩展</p>
<h2 id="assistant-27">assistant:</h2>
<p>在 C++ 中编写 PHP 扩展有点复杂，需要处理一些 PHP 内存管理和类型转换问题，但可以通过使用 PHP SDK 来简化过程。以下是一个简单的示例来帮助你开始编写 C++ PHP 扩展。</p>
<ol>
<li>
<p>前提条件：</p>
<p>在开始前，你需要提前安装好 C++ 编译器和 PHP SDK。你还需要了解 PHP 扩展基础知识，如内存管理和类型转换。</p>
</li>
<li>
<p>创建扩展：</p>
<p>在开始之前，你需要创建一个新的目录，在其中创建一个名为 <code>config.m4</code> 的文件。该文件用于配置 PHP 扩展的编译选项。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">PHP_ARG_ENABLE([my_extension],</span></span>
<span class="line"><span style="color: #c9d1d9">    [whether to enable my_extension support],</span></span>
<span class="line"><span style="color: #c9d1d9">    [AS_HELP_STRING([--enable-my_extension],</span></span>
<span class="line"><span style="color: #c9d1d9">        [Enable my_extension support])], no)</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">if test "$PHP_MY_EXTENSION" != "no"; then</span></span>
<span class="line"><span style="color: #c9d1d9">    PHP_NEW_EXTENSION([my_extension], [my_extension.cpp], [$ext_shared])</span></span>
<span class="line"><span style="color: #c9d1d9">fi</span></span></code></pre>
<p>在这个文件中，我们告诉 PHP 编译器要建立一个新的名为 <code>my_extension</code> 的扩展，并指定为 <code>my_extension.cpp</code> 这个 C++ 文件。现在，我们创建 <code>my_extension.cpp</code> 文件，我们将在这里编写扩展代码。</p>
</li>
<li>
<p>实现扩展：</p>
<p>在 <code>my_extension.cpp</code> 文件中，我们将包含以下头文件：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">#include</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"php.h"</span></span></code></pre>
<p>在文件底部，我们将编写 C/C++ 函数，但是我们在这些函数周围使用了 C++ 语言特性的命名空间：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">extern</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"C"</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #FF7B72">#ifdef</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">COMPILE_DL_MY_EXTENSION</span></span>
<span class="line"><span style="color: #D2A8FF">ZEND_GET_MODULE</span><span style="color: #C9D1D9">(my_extension)</span></span>
<span class="line"><span style="color: #FF7B72">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">PHP_FUNCTION</span><span style="color: #C9D1D9">(hello)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>上述代码包括了一个 hello 函数的声明，稍后我们将在其中实现我们的示例功能。现在我们需要实现宏 <code>ZEND_GET_MODULE</code>。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">#ifdef</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">COMPILE_DL_MY_EXTENSION</span></span>
<span class="line"><span style="color: #D2A8FF">ZEND_GET_MODULE</span><span style="color: #C9D1D9">(my_extension)</span></span>
<span class="line"><span style="color: #FF7B72">#endif</span></span></code></pre>
<p>它的作用是将 <code>my_extension</code> 模块与 PHP 引擎联系起来。该宏应在代码底部，通常要用 <code>ZEND_BEGIN_MODULE_GLOBALS(my_extension)</code> 启动，在中间放一些用户指定的代码（包括函数定义和全局变量），然后在最后一个调用 macro <code>ZEND_END_MODULE_GLOBALS(my_extension)</code>。</p>
<p>现在我们需要实现 <code>hello</code> 函数。</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #D2A8FF">PHP_FUNCTION</span><span style="color: #C9D1D9">(hello) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">RETURN_STRING</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Hello, world!"</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>在上述代码中，<code>PHP_FUNCTION</code> 宏用于声明一个 PHP 函数。在这里，我们要向 PHP 返回一个字符串值 “Hello, world!”。我们使用 <code>RETURN_STRING</code> 宏将字符串写入 PHP 函数的输出。参数 1 用于指示我们想要将字符串传送到一个桶里。因此，PHP 运行时将该字符串复制到新分配的字符串桶中。</p>
</li>
<li>
<p>编译扩展：</p>
<p>使用以下命令构建和安装扩展：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">phpize</span></span>
<span class="line"><span style="color: #C9D1D9">./configure --enable-my_extension</span></span>
<span class="line"><span style="color: #C9D1D9">make</span></span>
<span class="line"><span style="color: #C9D1D9">sudo make install</span></span></code></pre>
<p>在成功编译并安装扩展后，现在我们需要在 <code>php.ini</code> 文件中启用该扩展，这可以通过添加以下行来完成：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">extension = my_extension.so</span></span></code></pre>
</li>
<li>
<p>测试扩展：</p>
<p>编写一个简单的 PHP 脚本来测试扩展：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">&#x3C;?</span><span style="color: #79C0FF">php</span></span>
<span class="line"><span style="color: #79C0FF">echo</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">hello</span><span style="color: #C9D1D9">();</span></span></code></pre>
<p>如果一切顺利，你应该看到 “Hello, world!” 的输出。</p>
</li>
</ol>
<p>这只是一个简单的例子，真实的 PHP 扩展可能比这更复杂。但是，希望通过这个简单的示例，你能了解如何使用 C++ 实现 PHP 扩展。</p>
<h2 id="user-28">user:</h2>
<p>Javascript使用ArrayBuffer详解</p>
<h2 id="assistant-28">assistant:</h2>
<p>JavaScript 中的 ArrayBuffer 对象是一种用于表示通用的、固定长度的原始二进制数据的数据类型。它提供了一个缓冲区，可以存储任意类型的二进制数据。ArrayBuffer 对象是为了更好地处理与 WebSockets、WebGL 和 Web Audio API 等 APIs 有关的二进制数据而引入的。在本文中，我们将详细介绍 ArrayBuffer 对象。</p>
<ol>
<li>创建 ArrayBuffer 对象</li>
</ol>
<p>ArrayBuffer 对象的创建可以通过以下方式：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">ArrayBuffer</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">16</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">// 16 个字节的 ArrayBuffer 对象</span></span></code></pre>
<p>这将创建一个包含 16 个字节的 ArrayBuffer 对象。我们可以使用 <code>byteLength</code> 属性获取缓冲区大小：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(buf.byteLength); </span><span style="color: #8B949E">// 16</span></span></code></pre>
<ol start="2">
<li>操作 ArrayBuffer 对象</li>
</ol>
<p>我们可以使用 DataViews 来操作 ArrayBuffer 对象。创建 DataViews 有两种方式：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> dataview1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">DataView</span><span style="color: #C9D1D9">(buf); </span><span style="color: #8B949E">// 从 buf 开头创建 DataView</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> dataview2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">DataView</span><span style="color: #C9D1D9">(buf, </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">// 从 buf 的第 8 个字节开始创建 DataView</span></span></code></pre>
<p>在创建 DataView 后，您可以通过以下方式来读取和写入缓冲区中的数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">// 写入数据，传入参数按照数据类型来</span></span>
<span class="line"><span style="color: #C9D1D9">dataview.</span><span style="color: #D2A8FF">setUint8</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//在下标为 2 的位置写入一个 8 位无符号整数</span></span>
<span class="line"><span style="color: #C9D1D9">dataview.</span><span style="color: #D2A8FF">setInt16</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">16</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//在下标为 4 的位置写入一个 16 位带符号整数</span></span>
<span class="line"><span style="color: #C9D1D9">dataview.</span><span style="color: #D2A8FF">setFloat32</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">, Math.</span><span style="color: #79C0FF">PI</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//在下标为 8 的位置写入一个 32 位浮点型数据</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">// 读取数据，传入参数按照数据类型来</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> uintValue </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> dataview.</span><span style="color: #D2A8FF">getUint8</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//从下标为 2 的位置读取一个 8 位无符号整数</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> intValue </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> dataview.</span><span style="color: #D2A8FF">getInt16</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//从下标为 4 的位置读取一个 16 位带符号整数</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> floatValue </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> dataview.</span><span style="color: #D2A8FF">getFloat32</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//从下标为 8 的位置读取一个 32 位浮点型数据</span></span></code></pre>
<p>需要注意的是，写入和读取数据时您需要根据实际数据长度选择正确的方法，并指定正确的偏移量。</p>
<ol start="3">
<li>将 ArrayBuffer 转换为普通的 JavaScript 数组</li>
</ol>
<p>我们可以通过 DataViews 将 ArrayBuffer 转换为 JavaScript 数组。查看以下示例：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">ArrayBuffer</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> view </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">DataView</span><span style="color: #C9D1D9">(buf);</span></span>
<span class="line"><span style="color: #C9D1D9">view.</span><span style="color: #D2A8FF">setUint8</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0x12</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">view.</span><span style="color: #D2A8FF">setUint8</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0x34</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">view.</span><span style="color: #D2A8FF">setUint8</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0x56</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">view.</span><span style="color: #D2A8FF">setUint8</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0x78</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">view.</span><span style="color: #D2A8FF">setInt16</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> arr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">Int8Array</span><span style="color: #C9D1D9">(buf);</span></span>
<span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(arr); </span><span style="color: #8B949E">// [18, 52, 86, 120, -2, 0, 0, 0]</span></span></code></pre>
<p>上述代码可以将 ArrayBuffer 对象转换为 Int8Array 数组。</p>
<ol start="4">
<li>使用 ArrayBuffer 在 WebSockets、WebGL 和 Web Audio API 中</li>
</ol>
<p>ArrayBuffer 常用于 WebSockets、WebGL 和 Web Audio API 等特定的 WEB API 中，将二进制数据发送到服务器或在浏览器中播放音频。下面是几个示例：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">// WebSockets</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> ws </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(url);</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> message </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'WebSocket Test Message'</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">ArrayBuffer</span><span style="color: #C9D1D9">(message.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//设置缓存区</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> view </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">Int16Array</span><span style="color: #C9D1D9">(buf); </span><span style="color: #8B949E">//将缓存区拆分为Int16Array类型</span></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> message.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9">; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  view[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> message.</span><span style="color: #D2A8FF">charCodeAt</span><span style="color: #C9D1D9">(i); </span><span style="color: #8B949E">//将字符串转换为数字</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #C9D1D9">ws.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(buf); </span><span style="color: #8B949E">//发送二进制数据</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">// WebGL</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">gl</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> canvas.</span><span style="color: #D2A8FF">getContext</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"webgl"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> buf </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">ArrayBuffer</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">16</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> arr </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">Int32Array</span><span style="color: #C9D1D9">(buf);</span></span>
<span class="line"><span style="color: #C9D1D9">arr.</span><span style="color: #D2A8FF">set</span><span style="color: #C9D1D9">([</span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">]); </span><span style="color: #8B949E">//写入数据</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> glBuffer </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> gl.</span><span style="color: #D2A8FF">createBuffer</span><span style="color: #C9D1D9">(); </span><span style="color: #8B949E">//创建缓冲区</span></span>
<span class="line"><span style="color: #C9D1D9">gl.</span><span style="color: #D2A8FF">bindBuffer</span><span style="color: #C9D1D9">(gl.</span><span style="color: #79C0FF">ARRAY_BUFFER</span><span style="color: #C9D1D9">, glBuffer);</span></span>
<span class="line"><span style="color: #C9D1D9">gl.</span><span style="color: #D2A8FF">bufferData</span><span style="color: #C9D1D9">(gl.</span><span style="color: #79C0FF">ARRAY_BUFFER</span><span style="color: #C9D1D9">, buf, gl.</span><span style="color: #79C0FF">STATIC_DRAW</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//将数据写入缓冲区</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">// Web Audio API</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> context </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">AudioContext</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> bufferSource </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> context.</span><span style="color: #D2A8FF">createBufferSource</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> sampleRate </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">44100</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> duration </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.5</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> numSamples </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">44100</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.5</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> buffer </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">ArrayBuffer</span><span style="color: #C9D1D9">(numSamples </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">//设置缓存区</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> view </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">Int16Array</span><span style="color: #C9D1D9">(buffer); </span><span style="color: #8B949E">//将缓存区拆分为Int16Array类型</span></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; i </span><span style="color: #FF7B72">&#x3C;</span><span style="color: #C9D1D9"> numSamples; i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> t </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> sampleRate;</span></span>
<span class="line"><span style="color: #C9D1D9">  view[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> Math.</span><span style="color: #D2A8FF">sin</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> Math.</span><span style="color: #79C0FF">PI</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">440</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> t) </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0x7FFF</span><span style="color: #C9D1D9">; </span><span style="color: #8B949E">//将sin函数的值乘以最大的16位带符号整数值的一半，并将它存储为16位整数</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> audioBuffer </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> context.</span><span style="color: #D2A8FF">createBuffer</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, numSamples, sampleRate);</span></span>
<span class="line"><span style="color: #C9D1D9">audioBuffer.</span><span style="color: #D2A8FF">getChannelData</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">).</span><span style="color: #D2A8FF">set</span><span style="color: #C9D1D9">(view);</span></span>
<span class="line"><span style="color: #C9D1D9">bufferSource.buffer </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> audioBuffer;</span></span>
<span class="line"><span style="color: #C9D1D9">bufferSource.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(context.destination);</span></span>
<span class="line"><span style="color: #C9D1D9">bufferSource.</span><span style="color: #D2A8FF">start</span><span style="color: #C9D1D9">();</span></span></code></pre>
<p>以上示例演示了如何使用 ArrayBuffer 在 WebSockets、WebGL 和 Web Audio API 中发送或处理二进制数据。</p>
<p>总结：</p>
<p>ArrayBuffer 是一个非常有用的对象，可以处理任意类型的二进制数据，尤其是在与特定 WEB API（如WebSockets、WebGL 和 Web Audio API）一起使用时。了解 ArrayBuffer 的常见用例可以帮助您更好地处理二进制数据。</p>
<h2 id="user-29">user:</h2>
<p>sql</p>
<h2 id="assistant-29">assistant:</h2>
<p>SQL（Structured Query Language）是用于管理关系型数据库管理系统（RDBMS）中数据的标准语言，在计算机科学领域具有广泛的应用。它可以用于插入、更新、删除数据，以及查询和修改数据库中的内容。以下是 SQL 的基础知识和常用语句。</p>
<ol>
<li>创建表</li>
</ol>
<p>创建表格的基本语法如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">CREATE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">TABLE</span><span style="color: #C9D1D9"> table_name (</span></span>
<span class="line"><span style="color: #C9D1D9">    column1 datatype constraints,</span></span>
<span class="line"><span style="color: #C9D1D9">    column2 datatype constraints,</span></span>
<span class="line"><span style="color: #C9D1D9">    column3 datatype constraints,</span></span>
<span class="line"><span style="color: #C9D1D9">    ...</span></span>
<span class="line"><span style="color: #C9D1D9">);</span></span></code></pre>
<p>例如，我们要创建一个名为 <code>Users</code> 的表格，包括 <code>id</code>、<code>name</code> 和 <code>email</code> 列：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">CREATE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">TABLE</span><span style="color: #C9D1D9"> Users (</span></span>
<span class="line"><span style="color: #C9D1D9">    id </span><span style="color: #FF7B72">INT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NOT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NULL</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">PRIMARY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">KEY</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">VARCHAR</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">50</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">NOT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NULL</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    email </span><span style="color: #FF7B72">VARCHAR</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">NOT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NULL</span></span>
<span class="line"><span style="color: #C9D1D9">);</span></span></code></pre>
<p>在此示例中，我们创建了一个包含三列的 User 表格，并使用 <code>INT</code>、<code>VARCHAR</code> 和 <code>NOT NULL</code> 等列约束定义列的数据类型和属性。</p>
<ol start="2">
<li>插入数据</li>
</ol>
<p>向数据库表格中插入新的数据需要以下语法：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">INSERT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">INTO</span><span style="color: #C9D1D9"> table_name (column1, column2, column3, ...) </span></span>
<span class="line"><span style="color: #FF7B72">VALUES</span><span style="color: #C9D1D9"> (value1, value2, value3, ...);</span></span></code></pre>
<p>例如，假设我们想要向 <code>Users</code> 表格中添加一些数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">INSERT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">INTO</span><span style="color: #C9D1D9"> Users (id, </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">, email) </span></span>
<span class="line"><span style="color: #FF7B72">VALUES</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'John Doe'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'johndoe@example.com'</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">       (</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'Jane Smith'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'janesmith@example.com'</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">       (</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'Bob Johnson'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'bjohnson@example.com'</span><span style="color: #C9D1D9">);</span></span></code></pre>
<ol start="3">
<li>更新数据</li>
</ol>
<p>我们可以使用以下语法来更新数据库表格中现有的数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">UPDATE</span><span style="color: #C9D1D9"> table_name </span><span style="color: #FF7B72">SET</span><span style="color: #C9D1D9"> column1</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">value1, column2</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">value2, ... </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> condition;</span></span></code></pre>
<p>例如，如果我们想要更新用户 <code>id</code> 为 1 的电子邮件地址，可以执行以下语句：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">UPDATE</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">SET</span><span style="color: #C9D1D9"> email</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'newemail@example.com'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> id</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span></code></pre>
<ol start="4">
<li>删除数据</li>
</ol>
<p>我们可以使用以下语法来删除数据库表格中的数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">DELETE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> table_name </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> condition;</span></span></code></pre>
<p>例如，如果我们想要删除用户 <code>id</code> 为 2 的记录，可以执行以下语句：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">DELETE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> id</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span></code></pre>
<ol start="5">
<li>查询数据</li>
</ol>
<p>查询数据库表格中的数据需要以下语法：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> column1, column2, ... </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> table_name </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> condition;</span></span></code></pre>
<p>例如，如果我们要查询 <code>Users</code> 表格中的所有记录，可以执行以下语句：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users;</span></span></code></pre>
<p>以下是查询语句的其他示例：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">-- 选择特定列</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">, email </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">-- 选择特定行</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> id</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">-- 排序</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">ORDER BY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">ASC</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">-- 分组</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">COUNT</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">GROUP BY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">;</span></span></code></pre>
<p>总结：</p>
<p>SQL 是用于管理关系型数据库管理系统中数据的标准语言。了解 SQL 基础知识，如创建表、插入数据、更新数据、删除数据和查询数据等基本语句将有助于您理解和使用数据库。 具有良好的 SQL 技能的开发人员可以创建具有良好性能、高可用性和安全性的应用程序。</p>
<h2 id="user-30">user:</h2>
<p>sql</p>
<h2 id="assistant-30">assistant:</h2>
<p>SQL（Structured Query Language）是用于管理关系型数据库管理系统（RDBMS）中数据的标准语言，在计算机科学领域具有广泛的应用。它可以用于插入、更新、删除数据，以及查询和修改数据库中的内容。以下是 SQL 的基础知识和常用语句。</p>
<ol>
<li>创建表</li>
</ol>
<p>创建表格的基本语法如下：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">CREATE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">TABLE</span><span style="color: #C9D1D9"> table_name (</span></span>
<span class="line"><span style="color: #C9D1D9">    column1 datatype constraints,</span></span>
<span class="line"><span style="color: #C9D1D9">    column2 datatype constraints,</span></span>
<span class="line"><span style="color: #C9D1D9">    column3 datatype constraints,</span></span>
<span class="line"><span style="color: #C9D1D9">    ...</span></span>
<span class="line"><span style="color: #C9D1D9">);</span></span></code></pre>
<p>例如，我们要创建一个名为 <code>Users</code> 的表格，包括 <code>id</code>、<code>name</code> 和 <code>email</code> 列：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">CREATE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">TABLE</span><span style="color: #C9D1D9"> Users (</span></span>
<span class="line"><span style="color: #C9D1D9">    id </span><span style="color: #FF7B72">INT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NOT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NULL</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">PRIMARY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">KEY</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">VARCHAR</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">50</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">NOT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NULL</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    email </span><span style="color: #FF7B72">VARCHAR</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">NOT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">NULL</span></span>
<span class="line"><span style="color: #C9D1D9">);</span></span></code></pre>
<p>在此示例中，我们创建了一个包含三列的 User 表格，并使用 <code>INT</code>、<code>VARCHAR</code> 和 <code>NOT NULL</code> 等列约束定义列的数据类型和属性。</p>
<ol start="2">
<li>插入数据</li>
</ol>
<p>向数据库表格中插入新的数据需要以下语法：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">INSERT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">INTO</span><span style="color: #C9D1D9"> table_name (column1, column2, column3, ...) </span></span>
<span class="line"><span style="color: #FF7B72">VALUES</span><span style="color: #C9D1D9"> (value1, value2, value3, ...);</span></span></code></pre>
<p>例如，假设我们想要向 <code>Users</code> 表格中添加一些数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">INSERT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">INTO</span><span style="color: #C9D1D9"> Users (id, </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">, email) </span></span>
<span class="line"><span style="color: #FF7B72">VALUES</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'John Doe'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'johndoe@example.com'</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">       (</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'Jane Smith'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'janesmith@example.com'</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">       (</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'Bob Johnson'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'bjohnson@example.com'</span><span style="color: #C9D1D9">);</span></span></code></pre>
<ol start="3">
<li>更新数据</li>
</ol>
<p>我们可以使用以下语法来更新数据库表格中现有的数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">UPDATE</span><span style="color: #C9D1D9"> table_name </span><span style="color: #FF7B72">SET</span><span style="color: #C9D1D9"> column1</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">value1, column2</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">value2, ... </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> condition;</span></span></code></pre>
<p>例如，如果我们想要更新用户 <code>id</code> 为 1 的电子邮件地址，可以执行以下语句：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">UPDATE</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">SET</span><span style="color: #C9D1D9"> email</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'newemail@example.com'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> id</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span></code></pre>
<ol start="4">
<li>删除数据</li>
</ol>
<p>我们可以使用以下语法来删除数据库表格中的数据：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">DELETE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> table_name </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> condition;</span></span></code></pre>
<p>例如，如果我们想要删除用户 <code>id</code> 为 2 的记录，可以执行以下语句：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">DELETE</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> id</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span></code></pre>
<ol start="5">
<li>查询数据</li>
</ol>
<p>查询数据库表格中的数据需要以下语法：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> column1, column2, ... </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> table_name </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> condition;</span></span></code></pre>
<p>例如，如果我们要查询 <code>Users</code> 表格中的所有记录，可以执行以下语句：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users;</span></span></code></pre>
<p>以下是查询语句的其他示例：</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">-- 选择特定列</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">, email </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">-- 选择特定行</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">WHERE</span><span style="color: #C9D1D9"> id</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">-- 排序</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">ORDER BY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">ASC</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">-- 分组</span></span>
<span class="line"><span style="color: #FF7B72">SELECT</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">COUNT</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">FROM</span><span style="color: #C9D1D9"> Users </span><span style="color: #FF7B72">GROUP BY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">name</span><span style="color: #C9D1D9">;</span></span></code></pre>
<p>总结：</p>
<p>SQL 是用于管理关系型数据库管理系统中数据的标准语言。了解 SQL 基础知识，如创建表、插入数据、更新数据、删除数据和查询数据等基本语句将有助于您理解和使用数据库。 具有良好的 SQL 技能的开发人员可以创建具有良好性能、高可用性和安全性的应用程序。</p>
<h2 id="user-31">user:</h2>
<p>sql.js</p>
<h2 id="assistant-31">assistant:</h2>
<p><code>sql.js</code> 是一个纯 JavaScript 实现的 SQLite 数据库引擎，可以将 SQLite 数据库与网页和 Node.js 应用程序集成。它是一个轻量级库，可以用于在浏览器中查询本地文件和在 Node.js 应用程序中查询 SQLite 数据库。</p>
<p>与传统的数据库引擎不同，<code>sql.js</code> 通过在浏览器中使用 JavaScript 来实现数据库查询。这意味着您无需安装其他软件即可使用 SQLite 数据库。您可以直接将 <code>sql.js</code> 文件导入到您的项目中，然后用相应的 SQL 语句查询数据。</p>
<p><code>sql.js</code> 可以用于执行查询，插入、更新和删除数据，以及创建和管理表格。使用 <code>sql.js</code> 的步骤如下：</p>
<ol>
<li>下载并导入 <code>sql.js</code> 库。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">&#x3C;!-- HTML --></span></span>
<span class="line"><span style="color: #C9D1D9">&#x3C;</span><span style="color: #7EE787">script</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">src</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.5.0/sql.min.js"</span><span style="color: #C9D1D9">>&#x3C;/</span><span style="color: #7EE787">script</span><span style="color: #C9D1D9">></span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">// ES6</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> SQL </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'sql.js'</span><span style="color: #C9D1D9">;</span></span></code></pre>
<ol start="2">
<li>将 SQLite 数据库加载到内存中。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">xhr</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">XMLHttpRequest</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">xhr.</span><span style="color: #D2A8FF">open</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'GET'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'path/to/sqlite.db'</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">xhr.responseType </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'arraybuffer'</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">xhr.</span><span style="color: #D2A8FF">onload</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=></span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">uInt8Array</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">Uint8Array</span><span style="color: #C9D1D9">(xhr.response);</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">db</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">SQL</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">Database</span><span style="color: #C9D1D9">(uInt8Array);</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// 现在，您可以通过执行 SQL 语句来查询和修改数据库。</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">xhr.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">();</span></span></code></pre>
<ol start="3">
<li>执行 SQL 查询。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">// 查询所有用户的名称和电子邮件。</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">results</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> db.</span><span style="color: #D2A8FF">exec</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'SELECT name, email FROM users;'</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(results);</span></span></code></pre>
<ol start="4">
<li>插入数据。</li>
</ol>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E">// 向 users 表中插入一条新记录。</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">statement</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> db.</span><span style="color: #D2A8FF">prepare</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'INSERT INTO users (name, email) VALUES (:name, :email);'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">statement.</span><span style="color: #D2A8FF">getAsObject</span><span style="color: #C9D1D9">({</span><span style="color: #A5D6FF">':name'</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">'John Doe'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">':email'</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">'johndoe@example.com'</span><span style="color: #C9D1D9">});</span></span>
<span class="line"><span style="color: #C9D1D9">statement.</span><span style="color: #D2A8FF">run</span><span style="color: #C9D1D9">({</span><span style="color: #A5D6FF">':name'</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">'Jane Smith'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">':email'</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">'janesmith@example.com'</span><span style="color: #C9D1D9">});</span></span></code></pre>
<p>总之，<code>sql.js</code> 是一个非常有用的 JavaScript 库，它使我们能够在浏览器和 Node.js 应用程序中执行 SQLite 数据库查询，而无需安装其他软件。</p>
	</body></html>